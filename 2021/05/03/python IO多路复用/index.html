<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
  <!--自定义看板娘-->
  <script src="https://cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script>
  <script src="/live2d-widget/autoload.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome/css/font-awesome.min.css">
  
  

  
  <title itemprop="name">python IO多路复用 | 雨过天晴&amp;伞落人离&#39;s Blog</title>
  
    <link rel="shortcut icon" href="/images/favicon.ico">
  
  <meta http-equiv="x-dns-prefetch-control" content="on">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+SerifMerriweather|Merriweather+Sans|Source+Code+Pro|Ubuntu:400,700|Noto+Serif+SC" media="all">
  <link rel="dns-prefetch" href="//cdn.jsdelivr.net">
  <link rel="stylesheet" id="saukra_css-css" href="/css/style.css" type="text/css" media="all">
  <link rel="stylesheet" href="/css/lib.min.css" media="all">
  <link rel="stylesheet" href="/css/font.css" media="all">
  <link rel="stylesheet" href="/css/insight.css" media="all">
  <link rel="stylesheet" href="/css/jquery.fancybox.min.css" media="all">
  <link rel="stylesheet" href="/css/zoom.css" media="all">
  <link rel="stylesheet" type="text/css" href="/css/sharejs.css">
<!--   <link rel="stylesheet" id="saukra_css-css" href="https://2heng.xin/wp-content/cache/autoptimize/css/autoptimize_ad42a61f4c7d4bdd9f91afcff6b5dda5.css
" type="text/css" media="all"> -->
  <script>
  /*Initial Variables*/
  var mashiro_option = new Object();
  var mashiro_global = new Object();
  mashiro_option.NProgressON = true;
  /* 
   * 邮箱信息之类的东西可以填在这里，这些js变量基本都作用于sakura-app.js
   * 这样的设置仅是为了方便在基于PHP开发的主题中设置js变量，既然移植到了Node上，我想或许可以精简这一逻辑吧
   */
  mashiro_option.email_domain = "";
  mashiro_option.email_name = "";
  mashiro_option.cookie_version_control = "";
  mashiro_option.qzone_autocomplete = false;
  mashiro_option.site_name = "雨过天晴&伞落人离's Blog";
  mashiro_option.author_name = "雨过天晴&伞落人离's Blog";
  mashiro_option.site_url = "https://zwh-china.github.io";
  mashiro_option.v_appId = "isAVAfjr2p1f1KqnKuKxD4va-gzGzoHsz";
  mashiro_option.v_appKey = "aVVjA76SnnAo2kP4S9BuGwW4";
  mashiro_option.mathjax = "1";
  mashiro_option.qq_api_url = "https://api.mashiro.top/qqinfo/"; 
  mashiro_option.qq_avatar_api_url = "https://api.mashiro.top/qqinfo/";

  // mashiro_option.jsdelivr_css_src = "https://cdn.jsdelivr.net/gh/moezx/cdn@3.4.5/css/lib.min.css";
  // mashiro_option.float_player_on = true;

  /*End of Initial Variables*/
  </script>
  <script type="text/javascript">
  var bg = "https://cdn.jsdelivr.net/gh/zwh-china/cdn/img/1.jpg,https://cdn.jsdelivr.net/gh/zwh-china/cdn/img/2.jpg,https://cdn.jsdelivr.net/gh/zwh-china/cdn/img/3.jpg,https://cdn.jsdelivr.net/gh/zwh-china/cdn/img/4.jpg".split(",");
  var bgindex = Math.floor(Math.random()*bg.length);
  if (!!window.ActiveXObject || "ActiveXObject" in window) { //is IE?
    alert('朋友，IE浏览器未适配哦~');
  }
  </script>
  <style type="text/css">
  .hljs-ln{border-collapse:collapse}.hljs-ln td{padding:0}.hljs-ln-n:before{content:attr(data-line-number)}
  </style>
  <style type="text/css">.site-top .lower nav{display:block !important;}.author-profile i,.post-like a,.post-share .show-share,.sub-text,.we-info a,span.sitename,.post-more i:hover,#pagination a:hover,.post-content a:hover,.float-content i:hover{color:#FE9600}.feature i,.download,.navigator i:hover,.links ul li:before,.ar-time i,span.ar-circle,.object,.comment .comment-reply-link,.siren-checkbox-radio:checked + .siren-checkbox-radioInput:after{background:#FE9600}::-webkit-scrollbar-thumb{background:#FE9600}.download,.navigator i:hover,.link-title,.links ul li:hover,#pagination a:hover,.comment-respond input[type='submit']:hover{border-color:#FE9600}.entry-content a:hover,.site-info a:hover,.comment h4 a,#comments-navi a.prev,#comments-navi a.next,.comment h4 a:hover,.site-top ul li a:hover,.entry-title a:hover,#archives-temp h3,span.page-numbers.current,.sorry li a:hover,.site-title a:hover,i.iconfont.js-toggle-search.iconsearch:hover,.comment-respond input[type='submit']:hover{color:#FE9600}.comments .comments-main{display:block !important;}.comments .comments-hidden{display:none !important;}background-position:center center;background-attachment:inherit;}
  </style>
<meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="雨过天晴&伞落人离's Blog" type="application/atom+xml">
</head>

<body class="page-template page-template-user page-template-page-analytics page-template-userpage-analytics-php page page-id-1297 chinese-font serif isWebKit">
  <div class="scrollbar" id="bar">
  </div>
  <a href="#" class="cd-top faa-float animated"></a>
  <section id="main-container">
    <div class="headertop filter-dot">
  <div id="banner_wave_1"></div>
  <div id="banner_wave_2"></div>
  <figure id="centerbg" class="centerbg">
    <div class="focusinfo no-select">
      <div class="header-tou">
   <a href="https://zwh-china.github.io">
       <img src="https://cdn.jsdelivr.net/gh/zwh-china/cdn@master/img/custom/avatar.jpg">
   </a>
</div>
      <div class="header-info">
        <p>一沙一世界，一花一天堂。君掌盛无边，刹那成永恒。</p>
        <div class="top-social_v2">
          <li id="bg-pre">
            <img class="flipx" src="https://cdn.jsdelivr.net/gh/honjun/cdn@1.6/img/other/next-b.svg">
          </li>
          
            
              
                <li>
                  <a href="https://github.com/zwh-china?tab=repositories" target="_blank" class="social-github" title="github">
                    <img src="https://cdn.jsdelivr.net/gh/zwh-china/cdn@master/img/social/github.png">
                  </a>
                </li>
              
            
              
                <li>
                  <a href="http://weibo.com/" target="_blank" class="social-github" title="sina">
                    <img src="https://cdn.jsdelivr.net/gh/zwh-china/cdn@master/img/social/sina.png">
                  </a>
                </li>
              
            
              
                <li>
                  <a href="https://music.163.com/" target="_blank" class="social-github" title="wangyiyun">
                    <img src="https://cdn.jsdelivr.net/gh/zwh-china/cdn@master/img/social/wangyiyun.png">
                  </a>
                </li>
              
            
              
                <li>
                  <a href="https://www.zhihu.com/" target="_blank" class="social-github" title="zhihu">
                    <img src="https://cdn.jsdelivr.net/gh/zwh-china/cdn@master/img/social/zhihu.png">
                  </a>
                </li>
              
            
              
                <li>
                  <a href="mailto:zwh_china@outlook.com" target="_blank" class="social-github" title="email">
                    <img src="https://cdn.jsdelivr.net/gh/zwh-china/cdn@master/img/social/email.svg">
                  </a>
                </li>
              
            
              
                <li class="wechat">
                  <a href="/#">
                    <img src="https://cdn.jsdelivr.net/gh/zwh-china/cdn@master/img/social/wechat.png">
                  </a>
                  <div class="wechatInner">
                    <img src="https://cdn.jsdelivr.net/gh/zwh-china/cdn@master/img/custom/wechat.jpg">
                  </div>
                </li>
              
            
          
          <li id="bg-next">
            <img src="https://cdn.jsdelivr.net/gh/honjun/cdn@1.6/img/other/next-b.svg">
          </li>
        </div>
      </div>
    </div>
  </figure>
  <div id="video-container" style="">
    <video style="object-fit: fill" id="bgvideo" class="video" video-name="" src="" width="auto" preload="auto">
    </video>
    <div id="video-btn" class="loadvideo videolive">
    </div>
    <div id="video-add">
    </div>
    <div class="video-stu">
    </div>
  </div>
  <div class="headertop-down faa-float animated" onclick="headertop_down()">
    <span>
      <i class="fa fa-chevron-down" aria-hidden="true">
      </i>
    </span>
  </div>
</div>
    <div id="page" class="site wrapper">
      <header class="site-header no-select gizle sabit" role="banner">
  <div class="site-top">
    <div class="site-branding">
      <span class="site-title">
        <span class="logolink moe-mashiro">
          <a href="/">
            <span class="sakurasono"></span>
            <span class="shironeko">雨过天晴&amp;伞落人离&#39;s Blog</span>
          </a>
        </span>
      </span>
    </div>
    <div class="searchbox search-form-submit">
      <i class="iconfont js-toggle-search iconsearch icon-search">
      </i>
    </div>
    <div id="show-nav" class="showNav mobile-fit">
      <div class="line line1">
      </div>
      <div class="line line2">
      </div>
      <div class="line line3">
      </div>
    </div>
    <div class="lower-cantiner">
      <div class="lower">
        <nav class="mobile-fit-control hide">
          <ul id="menu-new" class="menu">
            
              <li>
                <a href="/">
                  <span class="faa-parent animated-hover">
                    <i class="fa  fa-fort-awesome faa-shake" aria-hidden="false"></i>
                    首页
                  </span>
                </a>
                
              </li>
            
              <li>
                <a href="/archives">
                  <span class="faa-parent animated-hover">
                    <i class="fa  fa-archive faa-shake" aria-hidden="false"></i>
                    归档
                  </span>
                </a>
                
                  <ul class="sub-menu">
                    
                      <li>
                        <a href="/categories/%E6%8A%80%E6%9C%AF/">
                          <i class="fa fa-code" aria-hidden="true"></i>
                          技术
                        </a>
                      </li>
                    
                      <li>
                        <a href="/categories/%E7%94%9F%E6%B4%BB/">
                          <i class="fa fa-file-text-o" aria-hidden="true"></i>
                          生活
                        </a>
                      </li>
                    
                      <li>
                        <a href="/categories/%E8%B5%84%E6%BA%90/">
                          <i class="fa fa-cloud-download" aria-hidden="true"></i>
                          资源
                        </a>
                      </li>
                    
                      <li>
                        <a href="/categories/%E9%9A%8F%E6%83%B3/">
                          <i class="fa fa-commenting-o" aria-hidden="true"></i>
                          随想
                        </a>
                      </li>
                    
                      <li>
                        <a href="/categories/%E8%BD%AC%E8%BD%BD/">
                          <i class="fa fa-book" aria-hidden="true"></i>
                          转载
                        </a>
                      </li>
                    
                  </ul>
                
              </li>
            
              <li>
                <a href="javascript:;">
                  <span class="faa-parent animated-hover">
                    <i class="fa  fa-list-ul faa-vertical" aria-hidden="false"></i>
                    清单
                  </span>
                </a>
                
                  <ul class="sub-menu">
                    
                      <li>
                        <a href="/tags/%E6%82%A6%E8%AF%BB/">
                          <i class="fa fa-th-list faa-bounce" aria-hidden="true"></i>
                          书单
                        </a>
                      </li>
                    
                      <li>
                        <a href="/bangumi/">
                          <i class="fa fa-film faa-vertical" aria-hidden="true"></i>
                          番组
                        </a>
                      </li>
                    
                      <li>
                        <a href="/music/">
                          <i class="fa fa-headphones" aria-hidden="true"></i>
                          歌单
                        </a>
                      </li>
                    
                      <li>
                        <a href="/tags/%E5%9B%BE%E9%9B%86/">
                          <i class="fa fa-photo" aria-hidden="true"></i>
                          图集
                        </a>
                      </li>
                    
                  </ul>
                
              </li>
            
              <li>
                <a href="/comment/">
                  <span class="faa-parent animated-hover">
                    <i class="fa  fa-pencil-square-o faa-tada" aria-hidden="false"></i>
                    留言板
                  </span>
                </a>
                
              </li>
            
              <li>
                <a href="/links/">
                  <span class="faa-parent animated-hover">
                    <i class="fa  fa-link faa-shake" aria-hidden="false"></i>
                    友人帐
                  </span>
                </a>
                
              </li>
            
              <li>
                <a href="/donate/">
                  <span class="faa-parent animated-hover">
                    <i class="fa  fa-heart faa-pulse" aria-hidden="false"></i>
                    赞赏
                  </span>
                </a>
                
              </li>
            
              <li>
                <a href="/">
                  <span class="faa-parent animated-hover">
                    <i class="fa  fa-leaf faa-wrench" aria-hidden="false"></i>
                    关于
                  </span>
                </a>
                
                  <ul class="sub-menu">
                    
                      <li>
                        <a href="/about/">
                          <i class="fa fa-meetup" aria-hidden="true"></i>
                          我？
                        </a>
                      </li>
                    
                      <li>
                        <a href="/theme-sakura/">
                          <i class="fa iconfont icon-sakura" aria-hidden="true"></i>
                          主题
                        </a>
                      </li>
                    
                      <li>
                        <a href="/lab/">
                          <i class="fa fa-cogs" aria-hidden="true"></i>
                          Lab
                        </a>
                      </li>
                    
                  </ul>
                
              </li>
            
              <li>
                <a href="/client/">
                  <span class="faa-parent animated-hover">
                    <i class="fa  fa-android faa-vertical" aria-hidden="false"></i>
                    客户端
                  </span>
                </a>
                
              </li>
            
              <li>
                <a href="/atom.xml">
                  <span class="faa-parent animated-hover">
                    <i class="fa  fa-rss faa-pulse" aria-hidden="false"></i>
                    RSS
                  </span>
                </a>
                
              </li>
            
          </ul>
        </nav>
      </div>
    </div>
  </div>
</header>

      <link rel="stylesheet" type="text/css" href="/css/sharejs.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.css">
<div class="pattern-center-blank"></div>

<div id="content" class="site-content">
  <div id="primary" class="content-area">
    <main id="main" class="site-main" role="main">
      <article id="post-1" class="post-1 post type-post status-publish format-standard has-post-thumbnail hentry category-uncategorized">
        <div class="toc"></div>
        <!--<div class="toc-entry-content"><!-- 套嵌目录使用（主要为了支援评论）-->
        
          <header class="entry-header">
            <h1 class="entry-title">python IO多路复用</h1>
            <p class="entry-census">&nbsp;·&nbsp;2021-5-3&nbsp;·&nbsp;<span id="busuanzi_value_page_pv"></span>次阅读</p></p>

            <hr>
          </header>
        
        <div class="entry-content">
          <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>最近正在写一个端口映射小程序。主要实现内网的端口转发功能。拿80端口的Apache举例来说，就是我在一个没有公网IP的内网建立了一个Apache服务器，但是这个web服务只能被内网访问，但是通过端口映射就能够通过有公网IP的服务器访问到本地的80端口服务</p>
<p>大概原理就是写了一个反向代理，通过反代数据来达到端口映射的效果。但是这种场景下单一的多线程已经满足不了我对性能的要求，进而我去了解了UNIX下的五种I/O模型，准备拿I/O多路复用的epoll来解决我的问题</p>
<p>最初的构想是，当服务器接到一个请求，客户端就会开一个套接字并把其放入一个线程去处理。相当于每有一个连接，我就会单独开一个线程。这样会使得程序的效率大大下降。因为在创建新线程时会涉及到上下文切换和内存的共享。所以我需要除了线程外的方法来解决这个问题</p>
<h2 id="Unix下五大I-O模型"><a href="#Unix下五大I-O模型" class="headerlink" title="Unix下五大I/O模型"></a>Unix下五大I/O模型</h2><ul>
<li><p>Blocking I/O </p>
</li>
<li><p>Non-blocking I/O </p>
</li>
<li><p>I/O multiplexing (select/poll/epoll) </p>
</li>
<li><p>Signal-driven (Sigio) </p>
</li>
<li><p>Asynchronous I/O (POSIX aio_ series functions) <img src="/2021/05/03/python%20IO%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8/yuque_diagram.png" alt="yuque_diagram"></p>
</li>
</ul>
<h3 id="阻塞式IO"><a href="#阻塞式IO" class="headerlink" title="阻塞式IO"></a>阻塞式IO</h3><p>阻塞式就是最常见的socket用法。</p>
<pre><code class="python">data = skt.recv(Buffer_Size)
</code></pre>
<p>这种接收默认下是阻塞的，在运行到这个函数后会执行系统调用，即从用户态到内核态的转换。此时就会阻塞等到内核返回数据内容。</p>
<h3 id="非阻塞式IO"><a href="#非阻塞式IO" class="headerlink" title="非阻塞式IO"></a>非阻塞式IO</h3><p>非阻塞即设置<code>skt.setblocking(True)</code>此时套接字便不会阻塞。在每次尝试<code>recv(Buffer_Size)</code>时回去问内核有没有数据，没有数据内核会返回错误，而不是等待数据到来</p>
<h3 id="多路复用IO"><a href="#多路复用IO" class="headerlink" title="多路复用IO"></a>多路复用IO</h3><p>这个是这次了解的重点。</p>
<h2 id="select"><a href="#select" class="headerlink" title="select"></a>select</h2><ul>
<li>select( )</li>
</ul>
<p><code>select</code>在python中的定义是<code>select.select(rlist, wlist, xlist[,timeout])</code>这个函数提供了直接面向Unix系统中<code>select()</code>系统调用的接口，其中前三个参数是等待对象的</p>
<pre><code>iterable: either integers representing file descriptors or objects with a parameterless method named fileno() returning such an integer:

    rlist: wait until ready for reading

    wlist: wait until ready for writing

    xlist: wait for an “exceptional condition” (see the manual page for what your system considers such a condition)

Empty iterables are allowed, but acceptance of three empty iterables is platform-dependent. (It is known to work on Unix but not on Windows.) The optional timeout argument specifies a time-out as a floating point number in seconds. When the timeout argument is omitted the function blocks until at least one file descriptor is ready. A time-out value of zero specifies a poll and never blocks.

The return value is a triple of lists of objects that are ready: subsets of the first three arguments. When the time-out is reached without a file descriptor becoming ready, three empty lists are returned.

Among the acceptable object types in the iterables are Python file objects (e.g. sys.stdin, or objects returned by open() or os.popen()), socket objects returned by socket.socket(). You may also define a wrapper class yourself, as long as it has an appropriate fileno() method (that really returns a file descriptor, not just a random integer).

Note

File objects on Windows are not acceptable, but sockets are. On Windows, the underlying select() function is provided by the WinSock library, and does not handle file descriptors that don’t originate from WinSock. 
</code></pre>
<p>说白了就是文件描述符<code>fd</code>，当然由于Python封装的特性，也可以传入套接字对象，函数会自动调用套接字对象中的<code>fileno</code>方法来间接获取<code>fd</code>这个函数在win下不能接受对象类型除了套接字对象(也就是普通的那种文件对象不行了)。然后超时参数默认是无限久也就是阻塞，如果设置超时时间，若在时间内没有获取到就会返回空List。那么也就顺便得知<code>select()</code>返回的类型是三个List。特别的如果超时时间为0，则表示直接不阻塞，说明这是一个poll。同时<code>select()</code>也是<code>select pool epool</code>中唯一可以在win上用的函数。可能是因为win下的I/O模型不同导致的。</p>
<p>看了别人的视屏教程我反而觉得<code>select()</code>的用法更适合用C来展现</p>
<p>先看<code>select()</code>的函数原型</p>
<pre><code class="c"> int select(int nfds, fd_set *readfds, fd_set *writefds, fd_set *exceptfds, struct timeval *timeout);
</code></pre>
<p>可以看到<code>select()</code>函数接受一个最大文件描述符，另三个主要参数是存储了文件描述符的bitmap分别表示读，写，异常，和超时时间</p>
<p>再看下以socket为例子的代码</p>
<pre><code class="c">  fd_set rset;
  sockfd = socket(AF_INET, SOCK_STREAM, 0);
  memset(&amp;addr, 0, sizeof (addr));
  addr.sin_family = AF_INET;
  addr.sin_port = htons(2000);
  addr.sin_addr.s_addr = INADDR_ANY;
  bind(sockfd,(struct sockaddr*)&amp;addr ,sizeof(addr));
  listen (sockfd, 5); 
 
  for (i=0;i&lt;5;i++) 
  &#123;
    memset(&amp;client, 0, sizeof (client));
    addrlen = sizeof(client);
    fds[i] = accept(sockfd,(struct sockaddr*)&amp;client, &amp;addrlen);
    if(fds[i] &gt; max)
        max = fds[i];
  &#125;
  
  while(1)&#123;
    FD_ZERO(&amp;rset);
      for (i = 0; i&lt; 5; i++ ) &#123;
          FD_SET(fds[i],&amp;rset);
      &#125;
 
       puts(&quot;round again&quot;);
    select(max+1, &amp;rset, NULL, NULL, NULL);
 
    for(i=0;i&lt;5;i++) &#123;
        if (FD_ISSET(fds[i], &amp;rset))&#123;
            memset(buffer,0,MAXBUF);
            read(fds[i], buffer, MAXBUF);
            puts(buffer);
        &#125;
    &#125;    
  &#125;
</code></pre>
<p>首先是创建了一个普通的TCP监听socket设置了最大监听量是5，循环accept，直到建立了5个连接的套接字，这里注意c语言accept返回的就直接是一个<code>int</code>类型的<code>fd</code>(文件描述符)而不是Python中的socket对象。然后记录下了文件描述符的最大值。然后把文件描述符放到一个bitmap里去也就是<code>FD_SET(fds[i],&amp;rset);</code>bitmap的结构类似一个数组，默认值全是0，若收到的5个<code>fd</code>分别为 1 2 3 4 5则会在bitmap中把对应的1 2 3 4 5位由0变成1。然后调用<code>select()</code>函数，传入参数最大的<code>fd+1</code>(具体为啥要加1可以认为是bitmap是一个数组从0存储所以需要加1)和储存了文件描述符的bitmap。当<code>select()</code>返回说明有socket可以接受数据了，这中间其实是用户态把bitmap利用<code>mmap</code>映射到内核，然后由内核轮询直到发现有数据来了，便会对bitmap中的描述符置位也就是类似插一个小旗子(flag)表明是这个<code>fd</code>有数据来了，便进行遍历判断是哪一位变了，然后进行读取。这最后遍历这部在python中似乎被直接完成了，因为python的select是有返回值的，返回的便是可以<code>recv()</code>的套接字对象。从这里也能看出Python是高度封装的语言，它把这种细节封装起来，使得我们写代码不必在意细枝末节。而c虽然略显复杂，却能很好展示<code>select()</code>的处理过程。</p>
<p>优点：1) 在c语言中它的优点就是它轮询的过程(检测socket是否有数据可接受)是在内核中进行，而非我自己用一个非阻塞IO去while True循环来反复进行用户态-内核态切换来占用开销。</p>
<p>缺点，1)在32位下bitmap大小默认是1024在64位下是2048也就是bitmap大小受限 2)在每次select后还得手动遍历，有O(n)复杂度</p>
<p>Python样例代码</p>
<pre><code class="python">#!/usr/bin/python
# -*- coding: utf-8 -*-
import select
import socket
import Queue

server = socket.socket(socket.AF_INET,socket.SOCK_STREAM)
server.setblocking(False)
server.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR  , 1)
server_address= (&#39;192.168.1.5&#39;,8080)
server.bind(server_address)
server.listen(10)

#select轮询等待读socket集合
inputs = [server]
#select轮询等待写socket集合
outputs = []
message_queues = &#123;&#125;
#select超时时间
timeout = 20

while True:
    print &quot;等待活动连接......&quot;
    readable , writable , exceptional = select.select(inputs, outputs, inputs, timeout)

    if not (readable or writable or exceptional) :
        print &quot;select超时无活动连接，重新select...... &quot;
        continue;
    #循环可读事件
    for s in readable :
        #如果是server监听的socket
        if s is server:
            #同意连接
            connection, client_address = s.accept()
            print &quot;新连接： &quot;, client_address
            connection.setblocking(0)
            #将连接加入到select可读事件队列
            inputs.append(connection)
            #新建连接为key的字典，写回读取到的消息
            message_queues[connection] = Queue.Queue()
        else:
            #不是本机监听就是客户端发来的消息
            data = s.recv(1024)
            if data :
                print &quot;收到数据：&quot; , data , &quot;客户端：&quot;,s.getpeername()
                message_queues[s].put(data)
                if s not in outputs:
                    #将读取到的socket加入到可写事件队列
                    outputs.append(s)
            else:
                #空白消息，关闭连接
                print &quot;关闭连接：&quot;, client_address
                if s in outputs :
                    outputs.remove(s)
                inputs.remove(s)
                s.close()
                del message_queues[s]
    for s in writable:
        try:
            msg = message_queues[s].get_nowait()
        except Queue.Empty:
            print &quot;连接：&quot; , s.getpeername() , &#39;消息队列为空&#39;
            outputs.remove(s)
        else:
            print &quot;发送数据：&quot; , msg , &quot;到&quot;, s.getpeername()
            s.send(msg)

    for s in exceptional:
        print &quot;异常连接：&quot;, s.getpeername()
        inputs.remove(s)
        if s in outputs:
            outputs.remove(s)
        s.close()
        del message_queues[s]
</code></pre>
<h2 id="poll"><a href="#poll" class="headerlink" title="poll"></a>poll</h2><ul>
<li><p>pool( )</p>
<pre><code>The poll() system call, supported on most Unix systems, provides better scalability for network servers that service many, many clients at the same time. poll() scales better because the system call only requires listing the file descriptors of interest, while select() builds a bitmap, turns on bits for the fds of interest, and then afterward the whole bitmap has to be linearly scanned again. select() is O(highest file descriptor), while poll() is O(number of file descriptors)
</code></pre>
<p>在python文档里也直接讲明了效率的差异在大部分情况下poll比select更好。因为<code>poll()</code>的系统调用只需要一个感兴趣也就是需要监听的文件描述符清单。而非是像<code>select()</code>一样需要建立一个bitmap并且需要对整个bitmap进行线性扫描。</p>
<p>先看看<code>poll()</code>的c语言函数原型</p>
<pre><code class="c">int poll (struct pollfd *fds, unsigned int nfds, int timeout);
</code></pre>
</li>
</ul>
<p>明显比<code>select()</code>简洁不少，它接收一个有关文件描述符的结构体，一个正整数表示文件描述符数量，和一个超时时间</p>
<p>再看下样例代码</p>
<pre><code class="c">struct pollfd &#123;
      int fd;
      short events; 
      short revents;
&#125;;

for (i=0;i&lt;5;i++) 
  &#123;
    memset(&amp;client, 0, sizeof (client));
    addrlen = sizeof(client);
    pollfds[i].fd = accept(sockfd,(struct sockaddr*)&amp;client, &amp;addrlen);
    pollfds[i].events = POLLIN;
  &#125;
  sleep(1);
  while(1)&#123;
      puts(&quot;round again&quot;);
    poll(pollfds, 5, 50000);
 
    for(i=0;i&lt;5;i++) &#123;
        if (pollfds[i].revents &amp; POLLIN)&#123;
            pollfds[i].revents = 0;
            memset(buffer,0,MAXBUF);
            read(pollfds[i].fd, buffer, MAXBUF);
            puts(buffer);
        &#125;
    &#125;
  &#125;
</code></pre>
<p>对于每一个文件描述符，我们都为其创建一个pollfd对象，其中fd参数就是文件描述符，events表示poll事件，是预定好的</p>
<table>
<thead>
<tr>
<th>事件</th>
<th>描述</th>
<th>是否可作为输入（events）</th>
<th>是否可作为输出（revents）</th>
</tr>
</thead>
<tbody><tr>
<td>POLLIN</td>
<td>数据可读（包括普通数据&amp;优先数据）</td>
<td>是</td>
<td>是</td>
</tr>
<tr>
<td>POLLOUT</td>
<td>数据可写（普通数据&amp;优先数据）</td>
<td>是</td>
<td>是</td>
</tr>
<tr>
<td>POLLRDNORM</td>
<td>普通数据可读</td>
<td>是</td>
<td>是</td>
</tr>
<tr>
<td>POLLRDBAND</td>
<td>优先级带数据可读（linux不支持）</td>
<td>是</td>
<td>是</td>
</tr>
<tr>
<td>POLLPRI</td>
<td>高优先级数据可读，比如TCP带外数据</td>
<td>是</td>
<td>是</td>
</tr>
<tr>
<td>POLLWRNORM</td>
<td>普通数据可写</td>
<td>是</td>
<td>是</td>
</tr>
<tr>
<td>POLLWRBAND</td>
<td>优先级带数据可写</td>
<td>是</td>
<td>是</td>
</tr>
<tr>
<td>POLLRDHUP</td>
<td>TCP连接被对端关闭，或者关闭了写操作，由GNU引入</td>
<td>是</td>
<td>是</td>
</tr>
<tr>
<td>POPPHUP</td>
<td>挂起</td>
<td>否</td>
<td>是</td>
</tr>
<tr>
<td>POLLERR</td>
<td>错误</td>
<td>否</td>
<td>是</td>
</tr>
<tr>
<td>POLLNVAL</td>
<td>文件描述符没有打开</td>
<td>否</td>
<td>是</td>
</tr>
</tbody></table>
<p>调用<code>poll()</code>后阻塞，若返回只需要遍历遍历文件描述符数量，将其<code>revents</code>重置为0，并对对应fd进行读取。</p>
<h4 id="Poll-vs-Select"><a href="#Poll-vs-Select" class="headerlink" title="Poll vs Select"></a>Poll vs Select</h4><ul>
<li>poll( ) does not require that the user calculate the value of the highest- numbered file descriptor +1</li>
<li>poll( ) is more efficient for large-valued file descriptors. Imagine watching a single file descriptor with the value 900 via select()—the  kernel would have to check each bit of each passed-in set, up to the  900th bit.</li>
<li>select( )’s file descriptor sets are statically sized.</li>
<li>With select( ), the file descriptor sets are reconstructed on  return, so each subsequent call must reinitialize them. The poll( )  system call separates the input (events field) from the output (revents  field), allowing the array to be reused without change.</li>
<li>The timeout parameter to select( ) is undefined on return. Portable  code needs to reinitialize it. This is not an issue with pselect( )</li>
<li>select( ) is more portable, as some Unix systems do not support poll( )</li>
</ul>
<p>这里其实还有一点，相较于之前的select，select每次需要构建一个bitmap，当每次select返回后，由于内核的置位，导致bitmap被直接更改了，所以再下次select前，必须重新初始化bitmap。这就造成其重用性较差。但是poll就不一样，我们只需要在处理文件描述符的时候顺手把revents给重新变为0即可。还有一点就是select的bitmap在被返回前所有没收到数据的位都被置为0，所以相当于其本身被改变了，所以没法类似poll这样给它变为0，只能乖乖重新生成。</p>
<p>再看Python对poll描述的官方文档</p>
<ul>
<li><p><code>poll.register</code>(<em>fd</em>[, <em>eventmask</em>])</p>
<p>Register a file descriptor with the polling object.  Future calls to the <a target="_blank" rel="noopener" href="https://docs.python.org/3/library/select.html#select.poll"><code>poll()</code></a> method will then check whether the file descriptor has any pending I/O events.  <em>fd</em> can be either an integer, or an object with a <a target="_blank" rel="noopener" href="https://docs.python.org/3/library/io.html#io.IOBase.fileno"><code>fileno()</code></a> method that returns an integer.  File objects implement <code>fileno()</code>, so they can also be used as the argument. <em>eventmask</em> is an optional bitmask describing the type of events you want to check for, and can be a combination of the constants <code>POLLIN</code>, <code>POLLPRI</code>, and <code>POLLOUT</code>, described in the table below.  If not specified, the default value used will check for all 3 types of events.    Constant Meaning  <code>POLLIN</code> There is data to read <code>POLLPRI</code> There is urgent data to read <code>POLLOUT</code> Ready for output: writing will not block <code>POLLERR</code> Error condition of some sort <code>POLLHUP</code> Hung up <code>POLLRDHUP</code> Stream socket peer closed connection, or shut down writing half of connection <code>POLLNVAL</code> Invalid request: descriptor not open  Registering a file descriptor that’s already registered is not an error, and has the same effect as registering the descriptor exactly once.</p>
</li>
<li><p><code>poll.modify</code>(<em>fd</em>, <em>eventmask</em>)</p>
<p>Modifies an already registered fd. This has the same effect as <code>register(fd, eventmask)</code>.  Attempting to modify a file descriptor that was never registered causes an <a target="_blank" rel="noopener" href="https://docs.python.org/3/library/exceptions.html#OSError"><code>OSError</code></a> exception with errno <code>ENOENT</code> to be raised.</p>
<table>
<thead>
<tr>
<th>Constant</th>
<th>Meaning</th>
</tr>
</thead>
<tbody><tr>
<td><code>POLLIN</code></td>
<td>There is data to read</td>
</tr>
<tr>
<td><code>POLLPRI</code></td>
<td>There is urgent data to read</td>
</tr>
<tr>
<td><code>POLLOUT</code></td>
<td>Ready for output: writing will not block</td>
</tr>
<tr>
<td><code>POLLERR</code></td>
<td>Error condition of some sort</td>
</tr>
<tr>
<td><code>POLLHUP</code></td>
<td>Hung up</td>
</tr>
<tr>
<td><code>POLLRDHUP</code></td>
<td>Stream socket peer closed connection, or shut down writing half of connection</td>
</tr>
<tr>
<td><code>POLLNVAL</code></td>
<td>Invalid request: descriptor not open</td>
</tr>
</tbody></table>
</li>
<li><p><code>poll.unregister</code>(<em>fd</em>)</p>
<p>Remove a file descriptor being tracked by a polling object.  Just like the <a target="_blank" rel="noopener" href="https://docs.python.org/3/library/select.html#select.poll.register"><code>register()</code></a> method, <em>fd</em> can be an integer or an object with a <a target="_blank" rel="noopener" href="https://docs.python.org/3/library/io.html#io.IOBase.fileno"><code>fileno()</code></a> method that returns an integer. Attempting to remove a file descriptor that was never registered causes a <a target="_blank" rel="noopener" href="https://docs.python.org/3/library/exceptions.html#KeyError"><code>KeyError</code></a> exception to be raised.</p>
</li>
<li><p><code>poll.poll</code>([<em>timeout</em>])</p>
<p>Polls the set of registered file descriptors, and returns a possibly-empty list containing <code>(fd, event)</code> 2-tuples for the descriptors that have events or errors to report. <em>fd</em> is the file descriptor, and <em>event</em> is a bitmask with bits set for the reported events for that descriptor — <code>POLLIN</code> for waiting input, <code>POLLOUT</code> to indicate that the descriptor can be written to, and so forth. An empty list indicates that the call timed out and no file descriptors had any events to report. If <em>timeout</em> is given, it specifies the length of time in milliseconds which the system will wait for events before returning. If <em>timeout</em> is omitted, negative, or <a target="_blank" rel="noopener" href="https://docs.python.org/3/library/constants.html#None"><code>None</code></a>, the call will block until there is an event for this poll object. Changed in version 3.5: The function is now retried with a recomputed timeout when interrupted by a signal, except if the signal handler raises an exception (see <a target="_blank" rel="noopener" href="https://www.python.org/dev/peps/pep-0475"><strong>PEP 475</strong></a> for the rationale), instead of raising <a target="_blank" rel="noopener" href="https://docs.python.org/3/library/exceptions.html#InterruptedError"><code>InterruptedError</code></a>.</p>
<p>首先需要去<code>poll.register()</code>一下，参数自然是文件描述符和event，然后特殊的，如果不指定event则会三种event都会被作为默认参数传入。<code>poll.modify()</code>就是去修改已经被<code>poll.register()</code>的文件描述符。至于<code>poll.unregister()</code>就不说了，取消一个已经注册的文件描述符。最后万事俱备，都注册完了就去调用<code>poll.poll()</code>去监测。其中的超时默认是阻塞，如果显式传入负数或者None也会是阻塞的，默认单位是毫秒。</p>
<p>Python2样例代码</p>
<pre><code class="python">#!/usr/bin/python
# -*- coding: utf-8 -*-
import socket
import select
import Queue

server = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
server.setblocking(False)
server.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
server_address = (&quot;192.168.1.5&quot;, 8080)
server.bind(server_address)
server.listen(5)
print  &quot;服务器启动成功，监听IP：&quot; , server_address
message_queues = &#123;&#125;
#超时，毫秒
timeout = 5000
#监听哪些事件
READ_ONLY = ( select.POLLIN | select.POLLPRI | select.POLLHUP | select.POLLERR)
READ_WRITE = (READ_ONLY|select.POLLOUT)
#新建轮询事件对象
poller = select.poll()
#注册本机监听socket到等待可读事件事件集合
poller.register(server,READ_ONLY)
#文件描述符到socket映射
fd_to_socket = &#123;server.fileno():server,&#125;
while True:
    print &quot;等待活动连接......&quot;
    #轮询注册的事件集合
    events = poller.poll(timeout)
    if not events:
      print &quot;poll超时，无活动连接，重新poll......&quot;
      continue
    print &quot;有&quot; , len(events), &quot;个新事件，开始处理......&quot;
    for fd ,flag in events:
        s = fd_to_socket[fd]
        #可读事件
        if flag &amp; (select.POLLIN | select.POLLPRI) :
            if s is server :
                #如果socket是监听的server代表有新连接
                connection , client_address = s.accept()
                print &quot;新连接：&quot; , client_address
                connection.setblocking(False)

                fd_to_socket[connection.fileno()] = connection
                #加入到等待读事件集合
                poller.register(connection,READ_ONLY)
                message_queues[connection]  = Queue.Queue()
            else :
                #接收客户端发送的数据
                data = s.recv(1024)
                if data:
                    print &quot;收到数据：&quot; , data , &quot;客户端：&quot; , s.getpeername()
                    message_queues[s].put(data)
                    #修改读取到消息的连接到等待写事件集合
                    poller.modify(s,READ_WRITE)
                else :
                    # Close the connection
                    print &quot;  closing&quot; , s.getpeername()
                    # Stop listening for input on the connection
                    poller.unregister(s)
                    s.close()
                    del message_queues[s]
        #连接关闭事件
        elif flag &amp; select.POLLHUP :
            print &quot; Closing &quot;, s.getpeername() ,&quot;(HUP)&quot;
            poller.unregister(s)
            s.close()
        #可写事件
        elif flag &amp; select.POLLOUT :
            try:
                msg = message_queues[s].get_nowait()
            except Queue.Empty:
                print s.getpeername() , &quot; queue empty&quot;
                poller.modify(s,READ_ONLY)
            else :
                print &quot;发送数据：&quot; , data , &quot;客户端：&quot; , s.getpeername()
                s.send(msg)
        #异常事件
        elif flag &amp; select.POLLERR:
            print &quot;  exception on&quot; , s.getpeername()
            poller.unregister(s)
            s.close()
            del message_queues[s]
</code></pre>
</li>
</ul>
<h2 id="epoll"><a href="#epoll" class="headerlink" title="epoll"></a>epoll</h2><p>epoll在c语言下主要由三个比较主要的函数组成<code>epoll_create()</code>、<code>epoll_ctl</code>、<code>epoll_wait()</code>组成。限于篇幅原因，不列出其函数原型。可以参考<a target="_blank" rel="noopener" href="https://blog.csdn.net/silly1195056983/article/details/112692781">https://blog.csdn.net/silly1195056983/article/details/112692781</a></p>
<p>看下c语言给的样例</p>
<pre><code class="c">struct epoll_event events[5];
  int epfd = epoll_create(10);
  ...
  ...
  for (i=0;i&lt;5;i++) 
  &#123;
    static struct epoll_event ev;
    memset(&amp;client, 0, sizeof (client));
    addrlen = sizeof(client);
    ev.data.fd = accept(sockfd,(struct sockaddr*)&amp;client, &amp;addrlen);
    ev.events = EPOLLIN;
    epoll_ctl(epfd, EPOLL_CTL_ADD, ev.data.fd, &amp;ev); 
  &#125;
  
  while(1)&#123;
      puts(&quot;round again&quot;);
      nfds = epoll_wait(epfd, events, 5, 10000);
    
    for(i=0;i&lt;nfds;i++) &#123;
            memset(buffer,0,MAXBUF);
            read(events[i].data.fd, buffer, MAXBUF);
            puts(buffer);
    &#125;
  &#125;
</code></pre>
<p>先用<code>epoll_create()</code>创建10个位置，用于监听文件描述符。再用类似poll的结构体存储fd和监听事件，注意这里没有revents，然后调用<code>epoll_ctl()</code>传入<code>epoll_create()</code>创建的监听列表，设置增加操作类型，传入文件描述符和事件类型。然后重复5次，表明监听5个socket文件描述符，然后调用<code>epoll_wait()</code>来进行阻塞等待，等待完后，只需要遍历<code>epoll_wait()</code>返回的序号进行对应读取。不需要像poll一样重置事件。</p>
<h4 id="Epoll-vs-Select-Poll"><a href="#Epoll-vs-Select-Poll" class="headerlink" title="Epoll vs Select/Poll"></a><strong>Epoll vs Select/Poll</strong></h4><ul>
<li>We can add and remove file descriptor while waiting</li>
<li>epoll_wait returns only the objects with ready file descriptors</li>
<li>epoll has better performance – O(1) instead of O(n)</li>
<li>epoll can behave as level triggered or edge triggered (see man page)</li>
<li>epoll is Linux specific so non portable</li>
</ul>
<p>其实<code>epoll_create()</code>创建的是一个红黑树，<code>epoll_ctl()</code>是对红黑树进行操作。这里的置位操作也有但是和poll()不太一样，因为epoll()没有revents。这里具体是如何操作的回头学了再补上，我看的视频对这个部分具体如何置位有争议。然后还有就是，这个给的例子是epoll()的水平触发还有一种边缘触发。这个似乎挺复杂的记录几个讲这个的url。回头去看</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_34793133/article/details/82055915">https://blog.csdn.net/qq_34793133/article/details/82055915</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/107995399">https://zhuanlan.zhihu.com/p/107995399</a></p>
<p>具体用c来说设置水平触发和边缘触发是在</p>
<pre><code class="c">//水平触发
evt.events = EPOLLIN;    // LT 水平触发 (默认) EPOLLLT
evt.data.fd = pfd[0];

//边沿触发
evt.events = EPOLLIN | EPOLLET;    // ET 边沿触发
evt.data.fd = pfd[0];
</code></pre>
<p>LT/ET应该就是分别代表，Level Trigger和Edge Trigger，也就是在设置事件和传入<code>epoll_ctl()</code>时设置。</p>
<p>至于这俩有啥区别和什么时候用，上面放的两个url中CSDN的标题就是<code>浅析epoll的水平触发和边缘触发，以及边缘触发为什么要使用非阻塞IO</code>这里再引用部分作者的文章内容</p>
<pre><code>我们通俗一点讲：

Level_triggered(水平触发)：当被监控的文件描述符上有可读写事件发生时，epoll_wait()会通知处理程序去读写。如果这次没有把数据一次性全部读写完(如读写缓冲区太小)，那么下次调用 epoll_wait()时，它还会通知你在上没读写完的文件描述符上继续读写，当然如果你一直不去读写，它会一直通知你！！！如果系统中有大量你不需要读写的就绪文件描述符，而它们每次都会返回，这样会大大降低处理程序检索自己关心的就绪文件描述符的效率！！！

Edge_triggered(边缘触发)：当被监控的文件描述符上有可读写事件发生时，epoll_wait()会通知处理程序去读写。如果这次没有把数据全部读写完(如读写缓冲区太小)，那么下次调用epoll_wait()时，它不会通知你，也就是它只会通知你一次，直到该文件描述符上出现第二次可读写事件才会通知你！！！这种模式比水平触发效率高，系统不会充斥大量你不关心的就绪文件描述符！！！

阻塞IO：当你去读一个阻塞的文件描述符时，如果在该文件描述符上没有数据可读，那么它会一直阻塞(通俗一点就是一直卡在调用函数那里)，直到有数据可读。当你去写一个阻塞的文件描述符时，如果在该文件描述符上没有空间(通常是缓冲区)可写，那么它会一直阻塞，直到有空间可写。以上的读和写我们统一指在某个文件描述符进行的操作，不单单指真正的读数据，写数据，还包括接收连接accept()，发起连接connect()等操作...

非阻塞IO：当你去读写一个非阻塞的文件描述符时，不管可不可以读写，它都会立即返回，返回成功说明读写操作完成了，返回失败会设置相应errno状态码，根据这个errno可以进一步执行其他处理。它不会像阻塞IO那样，卡在那里不动！！！
</code></pre>
<p>再看Python官方文档对epoll的介绍</p>
<h2 id="Edge-and-Level-Trigger-Polling-epoll-Objects"><a href="#Edge-and-Level-Trigger-Polling-epoll-Objects" class="headerlink" title="Edge and Level Trigger Polling (epoll) Objects"></a>Edge and Level Trigger Polling (epoll) Objects</h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://linux.die.net/man/4/epoll">https://linux.die.net/man/4/epoll</a></p>
<p><em>eventmask</em></p>
<table>
<thead>
<tr>
<th>Constant</th>
<th>Meaning</th>
</tr>
</thead>
<tbody><tr>
<td><code>EPOLLIN</code></td>
<td>Available for read</td>
</tr>
<tr>
<td><code>EPOLLOUT</code></td>
<td>Available for write</td>
</tr>
<tr>
<td><code>EPOLLPRI</code></td>
<td>Urgent data for read</td>
</tr>
<tr>
<td><code>EPOLLERR</code></td>
<td>Error condition happened on the assoc. fd</td>
</tr>
<tr>
<td><code>EPOLLHUP</code></td>
<td>Hang up happened on the assoc. fd</td>
</tr>
<tr>
<td><code>EPOLLET</code></td>
<td>Set Edge Trigger behavior, the default is Level Trigger behavior</td>
</tr>
<tr>
<td><code>EPOLLONESHOT</code></td>
<td>Set one-shot behavior. After one event is pulled out, the fd is internally disabled</td>
</tr>
<tr>
<td><code>EPOLLEXCLUSIVE</code></td>
<td>Wake only one epoll object when the associated fd has an event. The default (if this flag is not set) is to wake all epoll objects polling on a fd.</td>
</tr>
<tr>
<td><code>EPOLLRDHUP</code></td>
<td>Stream socket peer closed connection or shut down writing half of connection.</td>
</tr>
<tr>
<td><code>EPOLLRDNORM</code></td>
<td>Equivalent to <code>EPOLLIN</code></td>
</tr>
<tr>
<td><code>EPOLLRDBAND</code></td>
<td>Priority data band can be read.</td>
</tr>
<tr>
<td><code>EPOLLWRNORM</code></td>
<td>Equivalent to <code>EPOLLOUT</code></td>
</tr>
<tr>
<td><code>EPOLLWRBAND</code></td>
<td>Priority data may be written.</td>
</tr>
<tr>
<td><code>EPOLLMSG</code></td>
<td>Ignored.</td>
</tr>
</tbody></table>
<p>New in version 3.6: <code>EPOLLEXCLUSIVE</code> was added.  It’s only supported by Linux Kernel 4.5 or later.</p>
</blockquote>
<ul>
<li><p><code>epoll.close()</code></p>
<p>Close the control file descriptor of the epoll object.</p>
</li>
<li><p><code>epoll.closed()</code></p>
<p>True if the epoll object is closed.</p>
</li>
<li><p><code>epoll.fileno()</code></p>
<p>Return the file descriptor number of the control fd.</p>
</li>
<li><p><code>epoll.fromfd</code>(<em>fd</em>)</p>
<p>Create an epoll object from a given file descriptor.</p>
</li>
<li><p><code>epoll.register</code>(<em>fd</em>[, <em>eventmask</em>])</p>
<p>Register a fd descriptor with the epoll object.</p>
</li>
<li><p><code>epoll.modify</code>(<em>fd</em>, <em>eventmask</em>)</p>
<p>Modify a registered file descriptor.</p>
</li>
<li><p><code>epoll.unregister</code>(<em>fd</em>)</p>
<p>Remove a registered file descriptor from the epoll object. Changed in version 3.9: The method no longer ignores the <a target="_blank" rel="noopener" href="https://docs.python.org/3/library/errno.html#errno.EBADF"><code>EBADF</code></a> error.</p>
</li>
<li><p><code>epoll.poll</code>(<em>timeout=None</em>, <em>maxevents=-1</em>)</p>
<p>Wait for events. timeout in seconds (float)</p>
<p>感觉有点抽象，看一个样例代码吧</p>
<pre><code class="python">#!/usr/bin/python
# -*- coding: utf-8 -*-
import socket, select
import Queue

serversocket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
serversocket.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
server_address = (&quot;192.168.1.5&quot;, 8080)
serversocket.bind(server_address)
serversocket.listen(1)
print  &quot;服务器启动成功，监听IP：&quot; , server_address
serversocket.setblocking(0)
timeout = 10
#新建epoll事件对象，后续要监控的事件添加到其中
epoll = select.epoll()
#添加服务器监听fd到等待读事件集合
epoll.register(serversocket.fileno(), select.EPOLLIN)
message_queues = &#123;&#125;

fd_to_socket = &#123;serversocket.fileno():serversocket,&#125;
while True:
  print &quot;等待活动连接......&quot;
  #轮询注册的事件集合
  events = epoll.poll(timeout)
  if not events:
     print &quot;epoll超时无活动连接，重新轮询......&quot;
     continue
  print &quot;有&quot; , len(events), &quot;个新事件，开始处理......&quot;
  for fd, event in events:
     socket = fd_to_socket[fd]
     #可读事件
     if event &amp; select.EPOLLIN:
         #如果活动socket为服务器所监听，有新连接
         if socket == serversocket:
            connection, address = serversocket.accept()
            print &quot;新连接：&quot; , address
            connection.setblocking(0)
            #注册新连接fd到待读事件集合
            epoll.register(connection.fileno(), select.EPOLLIN)
            fd_to_socket[connection.fileno()] = connection
            message_queues[connection]  = Queue.Queue()
         #否则为客户端发送的数据
         else:
            data = socket.recv(1024)
            if data:
               print &quot;收到数据：&quot; , data , &quot;客户端：&quot; , socket.getpeername()
               message_queues[socket].put(data)
               #修改读取到消息的连接到等待写事件集合
               epoll.modify(fd, select.EPOLLOUT)
     #可写事件
     elif event &amp; select.EPOLLOUT:
        try:
           msg = message_queues[socket].get_nowait()
        except Queue.Empty:
           print socket.getpeername() , &quot; queue empty&quot;
           epoll.modify(fd, select.EPOLLIN)
        else :
           print &quot;发送数据：&quot; , data , &quot;客户端：&quot; , socket.getpeername()
           socket.send(msg)
     #关闭事件
     elif event &amp; select.EPOLLHUP:
        epoll.unregister(fd)
        fd_to_socket[fd].close()
        del fd_to_socket[fd]
epoll.unregister(serversocket.fileno())
epoll.close()
serversocket.close()
</code></pre>
</li>
</ul>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>总结就是，至少在python下select的兼容性比较好，在Linux和Win下都是通用的。然后一般来说poll和epoll用的比select多。因为在很多方面这俩都比select更好。同时我也了解到了数据结构的实际应用，因为poll和epoll中应用了bitmap 红黑树和链表。这其中我会在以后进行研究并发blog记录学习了解这几种数据结构并思考采用这些结构的原因。epoll被应用在Nginx和Redis这表明其结构是优秀的，大部分情况下可考虑采用epoll。同时epoll也采用了观察者的设计模式，这个回头也可以了解。</p>
<h2 id="To-do"><a href="#To-do" class="headerlink" title="To do"></a>To do</h2><ul>
<li>了解几种数据结构包括链表，红黑树，bitmap</li>
<li>更进一步了解epoll的用法，包含其水平触发和边缘触发</li>
<li>动手自己尝试用这几个模型</li>
<li>了解epoll的观察者设计模式</li>
<li>从数据结构解释epoll比poll更有优势的原因</li>
<li>对UNIX系统的文件描述符做更深入的了解</li>
</ul>
<h2 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h2><p>Python Select官方文档：<a target="_blank" rel="noopener" href="https://docs.python.org/3/library/select.html">https://docs.python.org/3/library/select.html</a></p>
<p>select/poll/epoll视屏讲解（讲的很好）:<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1qJ411w7du?from=search&amp;seid=10159331074298299316">https://www.bilibili.com/video/BV1qJ411w7du?from=search&amp;seid=10159331074298299316</a></p>
<p>select/poll/epoll Python代码样例:<a target="_blank" rel="noopener" href="https://www.cnblogs.com/muzinan110/p/5004469.html">https://www.cnblogs.com/muzinan110/p/5004469.html</a> P.S虽然是Python2但是无伤大雅</p>
<p>select/poll/epoll区别和C代码样例:<a target="_blank" rel="noopener" href="https://devarea.com/linux-io-multiplexing-select-vs-poll-vs-epoll/#.YI50iKERUUH">https://devarea.com/linux-io-multiplexing-select-vs-poll-vs-epoll/#.YI50iKERUUH</a></p>
<p>I/O样例图：<a target="_blank" rel="noopener" href="https://www.yuque.com/gotaoey/vaeroo/iqdfgh%E5%92%8C%E5%AF%B9%E5%BA%94%E8%A7%86%E9%A2%91%E8%AE%B2%E8%A7%A3https://www.bilibili.com/video/BV1vv4y1o7pu/?spm_id_from=333.788.recommend_more_video.0">https://www.yuque.com/gotaoey/vaeroo/iqdfgh和对应视频讲解https://www.bilibili.com/video/BV1vv4y1o7pu/?spm_id_from=333.788.recommend_more_video.0</a></p>
<p>还有很多引用在文中已经指出，由于引用资料较多此处列举未完敬请谅解</p>

        </div>
        <!-- .entry-content -->
        <div class="single-reward">
          <div class="reward-open">赏
            <div class="reward-main">
              <ul class="reward-row">
                <li class="alipay-code"><img src="https://cdn.jsdelivr.net/gh/zwh-china/cdn@master/img/custom/donate/AliPayQR.jpg"></li>
                <li class="wechat-code"><img src="https://cdn.jsdelivr.net/gh/zwh-china/cdn@master/img/custom/donate/WeChanQR.jpg"></li>
              </ul>
            </div>
          </div>
        </div>
        <div style="text-align:center; width: 100%" class="social-share share-mobile" data-disabled="diandian, tencent"></div>
        <footer class="post-footer">
          <div class="post-lincenses"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="nofollow"><i class="fa fa-creative-commons" aria-hidden="true"></i> 知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a></div>
          <div class="post-tags">
          </div>
          <div class="post-share">
            <div class="social-share sharehidden share-component"></div>
            <i class="iconfont show-share icon-forward"></i>
          </div>
        </footer><!-- .entry-footer -->
      </article>
      <!-- #post-## -->
      <div class="toc" style="background: none;"></div>
      <section class="post-squares nextprev">
        
          
            <div class="post-nepre half previous">
          
            <a href="/2021/05/14/%E7%BA%A2%E5%B8%BD%E6%9D%AF/" rel="prev">
              <div class="background">
                <img class="lazyload" src="https://cdn.jsdelivr.net/gh/honjun/cdn@1.6/img/loader/orange.progress-bar-stripe-loader.svg" data-src="" style="width: 100%; height: 100%; object-fit: cover; pointer-events: none;" onerror="imgError(this,3)" src="">
              </div>
              <span class="label">
              Previous Post</span>
              <div class="info">
                <h3>
                红帽杯wp</h3>
                <hr>
              </div>
            </a>
          </div>
        
        
          
            <div class="post-nepre half next">
          
            <a href="/2021/04/19/%E5%B9%B6%E8%A1%8C%E7%BC%96%E7%A8%8B%E5%AD%A6%E4%B9%A0/" rel="next">
              <div class="background">
                <img class="lazyload" src="https://cdn.jsdelivr.net/gh/honjun/cdn@1.6/img/loader/orange.progress-bar-stripe-loader.svg" data-src="" style="width: 100%; height: 100%; object-fit: cover; pointer-events: none;" onerror="imgError(this,3)" src="">
              </div>
              <span class="label">
              Next Post</span>
              <div class="info">
                <h3>
                并行编程学习</h3>
                <hr>
              </div>
            </a>
          </div>
        
      </section>
      
<div id="vcomments"></div>
<script>
  window.onload = function(){
      var valine = new Valine();
      valine.init({
        el: '#vcomments',
        appId: "isAVAfjr2p1f1KqnKuKxD4va-gzGzoHsz",
        appKey: "aVVjA76SnnAo2kP4S9BuGwW4",
        path: window.location.pathname,
        placeholder: "你是我一生只会遇见一次的惊喜 ..."
      })
  }
</script>

<section class="author-profile">
    <div class="info" itemprop="author" itemscope="" itemtype="https://schema.org/Person">
      <a href="/about/" class="profile gravatar"><img src="https://cdn.jsdelivr.net/gh/zwh-china/cdn@master/img/custom/avatar.jpg" itemprop="image" alt="雨过天晴&伞落人离" height="70" width="70"></a>
      <div class="meta">
        <span class="title">Author</span>
        <h3 itemprop="name">
        <a href="https://zwh-china.github.io" itemprop="url" rel="author">雨过天晴&伞落人离</a>
        </h3>
      </div>
    </div>
    <hr>
    <p><i class="iconfont icon-write"></i>一沙一世界，一花一天堂。君掌盛无边，刹那成永恒。</p>
  </section>
</div>



    </div>    
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="Type something..."/>
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: 'Posts',
            // PAGES: 'Pages',
            CATEGORIES: 'Categories',
            TAGS: 'Tags',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
    <!-- <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2021 雨过天晴&amp;伞落人离<br>
      powered_by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer> -->
<footer id="colophon" class="site-footer" role="contentinfo">
  <div class="site-info">
    <div class="footertext">
      <div class="img-preload">
        <img src="https://cdn.jsdelivr.net/gh/honjun/cdn@1.6/img/other/wordpress-rotating-ball-o.svg">
        <img src="https://cdn.jsdelivr.net/gh/honjun/cdn@1.6/img/other/disqus-preloader.svg">
      </div>
      <p style="color: #666666;">&copy 2018</p>
    </div>
    <div class="footer-device">
    <p style="font-family: 'Ubuntu', sans-serif;">
        <span style="color: #b9b9b9;">Theme <a href="https://github.com/honjun/hexo-theme-sakura" target="_blank" style="color: #b9b9b9;;text-decoration: underline dotted rgba(0, 0, 0, .1);">Sakura</a> <i class="iconfont icon-sakura rotating" style="color: #ffc0cb;display:inline-block"></i> by <a href="https://2heng.xin/" target="_blank" style="color: #b9b9b9;;text-decoration: underline dotted rgba(0, 0, 0, .1);">Mashiro</a>&<a href="https://www.hojun.cn/" target="_blank" style="color: #b9b9b9;;text-decoration: underline dotted rgba(0, 0, 0, .1);">Hojun</a>, Powered by Hexo, Hosted by Coding Pages</a>
        </span>
      </p>
    </div>
  </div><!-- .site-info -->
</footer>



<!-- <script src="/js/tocbot.js"></script> -->
<script type="text/javascript" src="/js/lib.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
<script type="text/javascript" src="/js/InsightSearch.js"></script>
<script type="text/javascript" src="/js/jquery.fancybox.min.js"></script>
<script type="text/javascript" src="/js/zoom.min.js"></script>
<script type="text/javascript" src="/js/sakura-app.js"></script>
<script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src='//unpkg.com/valine@1.3.4/dist/Valine.min.js'></script>
<script src="/js/botui.js"></script>
<!-- 不蒜子 网页计数器 -->
<script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.min.js"></script> -->
<script type="text/javascript">
/* <![CDATA[ */
if (/Android|webOS|iPhone|iPod|BlackBerry/i.test(navigator.userAgent)) {
  var Poi = {"pjax":"1","movies":{"url": "","name":"","live":"close"},"windowheight":"fixed","codelamp":"close","ajaxurl":"","order":"asc","formpostion":"bottom"};
} else {
  var Poi = {"pjax":"1","movies":{"url": "","name":"","live":"open"},"windowheight":"auto","codelamp":"close","ajaxurl":"","order":"asc","formpostion":"bottom"};
}
/* ]]> */

</script>
<script>
$(document).ready(function() {
  if ($(".toc").length > 0 && document.body.clientWidth > 1200) {
    if ($(".pattern-center").length > 0) { //有图的情况
      tocbot.init({
          // Where to render the table of contents.
          tocSelector: '.toc', // 放置目录的容器
          // Where to grab the headings to build the table of contents.
          contentSelector: '.entry-content', // 正文内容所在
          // Which headings to grab inside of the contentSelector element.
          scrollSmooth: true,
          headingSelector: 'h1, h2, h3, h4, h5', // 需要索引的标题级别
          headingsOffset: -400,
          scrollSmoothOffset: -85
      });
    } else {
      tocbot.init({
          // Where to render the table of contents.
          tocSelector: '.toc', // 放置目录的容器
          // Where to grab the headings to build the table of contents.
          contentSelector: '.entry-content', // 正文内容所在
          // Which headings to grab inside of the contentSelector element.
          scrollSmooth: true,
          headingSelector: 'h1, h2, h3, h4, h5', // 需要索引的标题级别
          headingsOffset: -85,
          scrollSmoothOffset: -85
      });
    }
    var offsetTop = $('.toc').offset().top - 95;
    window.onscroll = function() {
      var scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop;
      if (scrollTop >= offsetTop) {
        $('.toc').addClass('toc-fixed');
      } else {
        $('.toc').removeClass('toc-fixed');
      }
    }
  }
});
</script>
<!-- 🌸飘落 -->

    <div class="openNav no-select" style="height: 50px;">
      <div class="iconflat no-select" style="width: 50px; height: 50px;">
        <div class="icon"></div>
      </div>
      <div class="site-branding search-form-submit">
        <i class="iconfont js-toggle-search iconsearch icon-search"></i>
      </div>
    </div>
  </section>
  <div class="skin-menu no-select" id="mainskin" style="position: fixed">
 <div class="theme-controls row-container">
  <ul class="menu-list">
   <li id="white-bg"> <i class="fa fa-television" aria-hidden="true"></i></li>
   <li id="sakura-bg"> <i class="iconfont icon-sakura"></i></li>
   <li id="gribs-bg"> <i class="fa fa-slack" aria-hidden="true"></i></li>
   <li id="KAdots-bg"> <i class="iconfont icon-dots"></i></li>
   <li id="totem-bg"> <i class="fa fa-optin-monster" aria-hidden="true"></i></li>
   <li id="pixiv-bg"> <i class="iconfont icon-pixiv"></i></li>
   <li id="bing-bg"> <i class="iconfont icon-bing"></i></li>
   <li id="dark-bg"> <i class="fa fa-moon-o" aria-hidden="true"></i></li>
  </ul>
 </div>
</div>
<canvas id="night-mode-cover"></canvas> 
  <div class="changeSkin-gear no-select">
  <div class="keys" id="setbtn"> 
   <span id="open-skinMenu"> 切换主题 | SCHEME TOOL  
     <i class="iconfont icon-gear inline-block rotating"></i> 
   </span>
  </div>
</div>
  <div id="mo-nav" class="">
  <div class="m-avatar">
    <img src="https://cdn.jsdelivr.net/gh/zwh-china/cdn@master/img/custom/avatar.jpg">
  </div>
  <p style="text-align: center; color: #333; font-weight: 900; font-family: 'Ubuntu', sans-serif; letter-spacing: 1.5px">雨过天晴&伞落人离's Blog</p>
  <p style="text-align: center; word-spacing: 20px;">
    
      
        <a href="http://github.com/zwh-china" class="fa fa-github" target="_blank" style="color: #333; margin-left:20px"></a>
      
        <a href="http://weibo.com/" class="fa fa-weibo" target="_blank" style="color: #dd4b39; margin-left:20px"></a>
      
        <a href="https://wpa.qq.com/msgrd?v=3&uin=2540649733&site=qq&menu=yes" class="fa fa-qq" target="_blank" style="color: #25c6fe; margin-left:20px"></a>
      
    
  </p>
  <ul id="menu-new-1" class="menu">
    
      <li>
        <a href="/">
          <span class="faa-parent animated-hover">
            <i class="fa  fa-fort-awesome faa-shake" aria-hidden="true"></i>
            首页
          </span>
        </a>
        
      </li>
    
      <li>
        <a href="/archives">
          <span class="faa-parent animated-hover">
            <i class="fa  fa-archive faa-shake" aria-hidden="true"></i>
            归档
          </span>
        </a>
        
          <ul class="sub-menu">
            
              <li>
                <a href="/categories/%E6%8A%80%E6%9C%AF/">
                  <i class="fa fa-code" aria-hidden="true"></i>
                  技术
                </a>
              </li>
            
              <li>
                <a href="/categories/%E7%94%9F%E6%B4%BB/">
                  <i class="fa fa-file-text-o" aria-hidden="true"></i>
                  生活
                </a>
              </li>
            
              <li>
                <a href="/categories/%E8%B5%84%E6%BA%90/">
                  <i class="fa fa-cloud-download" aria-hidden="true"></i>
                  资源
                </a>
              </li>
            
              <li>
                <a href="/categories/%E9%9A%8F%E6%83%B3/">
                  <i class="fa fa-commenting-o" aria-hidden="true"></i>
                  随想
                </a>
              </li>
            
              <li>
                <a href="/categories/%E8%BD%AC%E8%BD%BD/">
                  <i class="fa fa-book" aria-hidden="true"></i>
                  转载
                </a>
              </li>
            
          </ul>
        
      </li>
    
      <li>
        <a href="javascript:;">
          <span class="faa-parent animated-hover">
            <i class="fa  fa-list-ul faa-vertical" aria-hidden="true"></i>
            清单
          </span>
        </a>
        
          <ul class="sub-menu">
            
              <li>
                <a href="/tags/%E6%82%A6%E8%AF%BB/">
                  <i class="fa fa-th-list faa-bounce" aria-hidden="true"></i>
                  书单
                </a>
              </li>
            
              <li>
                <a href="/bangumi/">
                  <i class="fa fa-film faa-vertical" aria-hidden="true"></i>
                  番组
                </a>
              </li>
            
              <li>
                <a href="/music/">
                  <i class="fa fa-headphones" aria-hidden="true"></i>
                  歌单
                </a>
              </li>
            
              <li>
                <a href="/tags/%E5%9B%BE%E9%9B%86/">
                  <i class="fa fa-photo" aria-hidden="true"></i>
                  图集
                </a>
              </li>
            
          </ul>
        
      </li>
    
      <li>
        <a href="/comment/">
          <span class="faa-parent animated-hover">
            <i class="fa  fa-pencil-square-o faa-tada" aria-hidden="true"></i>
            留言板
          </span>
        </a>
        
      </li>
    
      <li>
        <a href="/links/">
          <span class="faa-parent animated-hover">
            <i class="fa  fa-link faa-shake" aria-hidden="true"></i>
            友人帐
          </span>
        </a>
        
      </li>
    
      <li>
        <a href="/donate/">
          <span class="faa-parent animated-hover">
            <i class="fa  fa-heart faa-pulse" aria-hidden="true"></i>
            赞赏
          </span>
        </a>
        
      </li>
    
      <li>
        <a href="/">
          <span class="faa-parent animated-hover">
            <i class="fa  fa-leaf faa-wrench" aria-hidden="true"></i>
            关于
          </span>
        </a>
        
          <ul class="sub-menu">
            
              <li>
                <a href="/about/">
                  <i class="fa fa-meetup" aria-hidden="true"></i>
                  我？
                </a>
              </li>
            
              <li>
                <a href="/theme-sakura/">
                  <i class="fa iconfont icon-sakura" aria-hidden="true"></i>
                  主题
                </a>
              </li>
            
              <li>
                <a href="/lab/">
                  <i class="fa fa-cogs" aria-hidden="true"></i>
                  Lab
                </a>
              </li>
            
          </ul>
        
      </li>
    
      <li>
        <a href="/client/">
          <span class="faa-parent animated-hover">
            <i class="fa  fa-android faa-vertical" aria-hidden="true"></i>
            客户端
          </span>
        </a>
        
      </li>
    
      <li>
        <a href="/atom.xml">
          <span class="faa-parent animated-hover">
            <i class="fa  fa-rss faa-pulse" aria-hidden="true"></i>
            RSS
          </span>
        </a>
        
      </li>
    
  </ul>
  <p style="text-align: center; font-size: 13px; color: #b9b9b9;">&copy 2019 hexo-sakura</p>
</div>
<button onclick="topFunction()" class="mobile-cd-top" id="moblieGoTop" title="Go to top" style="display: none;"><i class="fa fa-chevron-up" aria-hidden="true"></i></button>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css">
<script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script>
<!-- require MetingJS -->
<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>
<style>
  .aplayer .aplayer-lrc {
    height: 35px;
  }
  .aplayer .aplayer-lrc p{
    font-size: 16px;
    font-weight: 700;
    line-height: 18px !important;
  }
  .aplayer .aplayer-lrc p.aplayer-lrc-current{
    color: #FF1493;
  }
  .aplayer.aplayer-narrow .aplayer-body{
    left: -66px !important;
  }
  .aplayer.aplayer-fixed .aplayer-lrc {
    display: none;
  }
  .aplayer .aplayer-lrc.aplayer-lrc-hide {
      display:none !important;
  }
  .aplayer.aplayer-fixed .lrc-show {
    display: block;
    background: rgba(255, 255, 255, 0.8);
  }
</style>
<meting-js

    id="2660651585"

    server="netease"

    type="playlist"

    fixed="true"

    autoplay="false"

    loop="all"

    order="random"

    preload="auto"

    volume="0.7"

    mutex="true"

</meting-js>
<script>
  $(function(){
    $('body').on('click', '.aplayer', function(){
      if($('.aplayer-button').hasClass('aplayer-play')) {
        $('.aplayer-lrc').removeClass('lrc-show');
      } else {
        $('.aplayer-lrc').addClass('lrc-show');
      }
    })
  });
</script>

</body>
</html>
<script src="https://cdn.jsdelivr.net/gh/stevenjoezhang/live2d-widget@latest/autoload.js"></script>