<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
  <!--自定义看板娘-->
  <script src="https://cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script>
  <script src="/live2d-widget/autoload.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome/css/font-awesome.min.css">
  
  

  
  <title itemprop="name">python并行2 | 雨过天晴&amp;伞落人离&#39;s Blog</title>
  
    <link rel="shortcut icon" href="/images/favicon.ico">
  
  <meta http-equiv="x-dns-prefetch-control" content="on">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+SerifMerriweather|Merriweather+Sans|Source+Code+Pro|Ubuntu:400,700|Noto+Serif+SC" media="all">
  <link rel="dns-prefetch" href="//cdn.jsdelivr.net">
  <link rel="stylesheet" id="saukra_css-css" href="/css/style.css" type="text/css" media="all">
  <link rel="stylesheet" href="/css/lib.min.css" media="all">
  <link rel="stylesheet" href="/css/font.css" media="all">
  <link rel="stylesheet" href="/css/insight.css" media="all">
  <link rel="stylesheet" href="/css/jquery.fancybox.min.css" media="all">
  <link rel="stylesheet" href="/css/zoom.css" media="all">
  <link rel="stylesheet" type="text/css" href="/css/sharejs.css">
<!--   <link rel="stylesheet" id="saukra_css-css" href="https://2heng.xin/wp-content/cache/autoptimize/css/autoptimize_ad42a61f4c7d4bdd9f91afcff6b5dda5.css
" type="text/css" media="all"> -->
  <script>
  /*Initial Variables*/
  var mashiro_option = new Object();
  var mashiro_global = new Object();
  mashiro_option.NProgressON = true;
  /* 
   * 邮箱信息之类的东西可以填在这里，这些js变量基本都作用于sakura-app.js
   * 这样的设置仅是为了方便在基于PHP开发的主题中设置js变量，既然移植到了Node上，我想或许可以精简这一逻辑吧
   */
  mashiro_option.email_domain = "";
  mashiro_option.email_name = "";
  mashiro_option.cookie_version_control = "";
  mashiro_option.qzone_autocomplete = false;
  mashiro_option.site_name = "雨过天晴&伞落人离's Blog";
  mashiro_option.author_name = "雨过天晴&伞落人离's Blog";
  mashiro_option.site_url = "https://zwh-china.github.io";
  mashiro_option.v_appId = "isAVAfjr2p1f1KqnKuKxD4va-gzGzoHsz";
  mashiro_option.v_appKey = "aVVjA76SnnAo2kP4S9BuGwW4";
  mashiro_option.mathjax = "1";
  mashiro_option.qq_api_url = "https://api.mashiro.top/qqinfo/"; 
  mashiro_option.qq_avatar_api_url = "https://api.mashiro.top/qqinfo/";

  // mashiro_option.jsdelivr_css_src = "https://cdn.jsdelivr.net/gh/moezx/cdn@3.4.5/css/lib.min.css";
  // mashiro_option.float_player_on = true;

  /*End of Initial Variables*/
  </script>
  <script type="text/javascript">
  var bg = "https://cdn.jsdelivr.net/gh/zwh-china/cdn/img/1.jpg,https://cdn.jsdelivr.net/gh/zwh-china/cdn/img/2.jpg,https://cdn.jsdelivr.net/gh/zwh-china/cdn/img/3.jpg,https://cdn.jsdelivr.net/gh/zwh-china/cdn/img/4.png".split(",");
  var bgindex = Math.floor(Math.random()*bg.length);
  if (!!window.ActiveXObject || "ActiveXObject" in window) { //is IE?
    alert('朋友，IE浏览器未适配哦~');
  }
  </script>
  <style type="text/css">
  .hljs-ln{border-collapse:collapse}.hljs-ln td{padding:0}.hljs-ln-n:before{content:attr(data-line-number)}
  </style>
  <style type="text/css">.site-top .lower nav{display:block !important;}.author-profile i,.post-like a,.post-share .show-share,.sub-text,.we-info a,span.sitename,.post-more i:hover,#pagination a:hover,.post-content a:hover,.float-content i:hover{color:#FE9600}.feature i,.download,.navigator i:hover,.links ul li:before,.ar-time i,span.ar-circle,.object,.comment .comment-reply-link,.siren-checkbox-radio:checked + .siren-checkbox-radioInput:after{background:#FE9600}::-webkit-scrollbar-thumb{background:#FE9600}.download,.navigator i:hover,.link-title,.links ul li:hover,#pagination a:hover,.comment-respond input[type='submit']:hover{border-color:#FE9600}.entry-content a:hover,.site-info a:hover,.comment h4 a,#comments-navi a.prev,#comments-navi a.next,.comment h4 a:hover,.site-top ul li a:hover,.entry-title a:hover,#archives-temp h3,span.page-numbers.current,.sorry li a:hover,.site-title a:hover,i.iconfont.js-toggle-search.iconsearch:hover,.comment-respond input[type='submit']:hover{color:#FE9600}.comments .comments-main{display:block !important;}.comments .comments-hidden{display:none !important;}background-position:center center;background-attachment:inherit;}
  </style>
<meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="雨过天晴&伞落人离's Blog" type="application/atom+xml">
</head>

<body class="page-template page-template-user page-template-page-analytics page-template-userpage-analytics-php page page-id-1297 chinese-font serif isWebKit">
  <div class="scrollbar" id="bar">
  </div>
  <a href="#" class="cd-top faa-float animated"></a>
  <section id="main-container">
    <div class="headertop filter-dot">
  <div id="banner_wave_1"></div>
  <div id="banner_wave_2"></div>
  <figure id="centerbg" class="centerbg">
    <div class="focusinfo no-select">
      <div class="header-tou">
   <a href="https://zwh-china.github.io">
       <img src="https://cdn.jsdelivr.net/gh/zwh-china/cdn@master/img/custom/avatar.jpg">
   </a>
</div>
      <div class="header-info">
        <p>一沙一世界，一花一天堂。君掌盛无边，刹那成永恒。</p>
        <div class="top-social_v2">
          <li id="bg-pre">
            <img class="flipx" src="https://cdn.jsdelivr.net/gh/honjun/cdn@1.6/img/other/next-b.svg">
          </li>
          
            
              
                <li>
                  <a href="https://github.com/zwh-china?tab=repositories" target="_blank" class="social-github" title="github">
                    <img src="https://cdn.jsdelivr.net/gh/zwh-china/cdn@master/img/social/github.png">
                  </a>
                </li>
              
            
              
                <li>
                  <a href="http://weibo.com/" target="_blank" class="social-github" title="sina">
                    <img src="https://cdn.jsdelivr.net/gh/zwh-china/cdn@master/img/social/sina.png">
                  </a>
                </li>
              
            
              
                <li>
                  <a href="https://music.163.com/" target="_blank" class="social-github" title="wangyiyun">
                    <img src="https://cdn.jsdelivr.net/gh/zwh-china/cdn@master/img/social/wangyiyun.png">
                  </a>
                </li>
              
            
              
                <li>
                  <a href="https://www.zhihu.com/" target="_blank" class="social-github" title="zhihu">
                    <img src="https://cdn.jsdelivr.net/gh/zwh-china/cdn@master/img/social/zhihu.png">
                  </a>
                </li>
              
            
              
                <li>
                  <a href="mailto:zwh_china@outlook.com" target="_blank" class="social-github" title="email">
                    <img src="https://cdn.jsdelivr.net/gh/zwh-china/cdn@master/img/social/email.svg">
                  </a>
                </li>
              
            
              
                <li class="wechat">
                  <a href="/#">
                    <img src="https://cdn.jsdelivr.net/gh/zwh-china/cdn@master/img/social/wechat.png">
                  </a>
                  <div class="wechatInner">
                    <img src="https://cdn.jsdelivr.net/gh/zwh-china/cdn@master/img/custom/wechat.jpg">
                  </div>
                </li>
              
            
          
          <li id="bg-next">
            <img src="https://cdn.jsdelivr.net/gh/honjun/cdn@1.6/img/other/next-b.svg">
          </li>
        </div>
      </div>
    </div>
  </figure>
  <div id="video-container" style="">
    <video style="object-fit: fill" id="bgvideo" class="video" video-name="" src="" width="auto" preload="auto">
    </video>
    <div id="video-btn" class="loadvideo videolive">
    </div>
    <div id="video-add">
    </div>
    <div class="video-stu">
    </div>
  </div>
  <div class="headertop-down faa-float animated" onclick="headertop_down()">
    <span>
      <i class="fa fa-chevron-down" aria-hidden="true">
      </i>
    </span>
  </div>
</div>
    <div id="page" class="site wrapper">
      <header class="site-header no-select gizle sabit" role="banner">
  <div class="site-top">
    <div class="site-branding">
      <span class="site-title">
        <span class="logolink moe-mashiro">
          <a href="/">
            <span class="sakurasono"></span>
            <span class="shironeko">雨过天晴&amp;伞落人离&#39;s Blog</span>
          </a>
        </span>
      </span>
    </div>
    <div class="searchbox search-form-submit">
      <i class="iconfont js-toggle-search iconsearch icon-search">
      </i>
    </div>
    <div id="show-nav" class="showNav mobile-fit">
      <div class="line line1">
      </div>
      <div class="line line2">
      </div>
      <div class="line line3">
      </div>
    </div>
    <div class="lower-cantiner">
      <div class="lower">
        <nav class="mobile-fit-control hide">
          <ul id="menu-new" class="menu">
            
              <li>
                <a href="/">
                  <span class="faa-parent animated-hover">
                    <i class="fa  fa-fort-awesome faa-shake" aria-hidden="false"></i>
                    首页
                  </span>
                </a>
                
              </li>
            
              <li>
                <a href="/archives">
                  <span class="faa-parent animated-hover">
                    <i class="fa  fa-archive faa-shake" aria-hidden="false"></i>
                    归档
                  </span>
                </a>
                
                  <ul class="sub-menu">
                    
                      <li>
                        <a href="/categories/%E6%8A%80%E6%9C%AF/">
                          <i class="fa fa-code" aria-hidden="true"></i>
                          技术
                        </a>
                      </li>
                    
                      <li>
                        <a href="/categories/%E7%94%9F%E6%B4%BB/">
                          <i class="fa fa-file-text-o" aria-hidden="true"></i>
                          生活
                        </a>
                      </li>
                    
                      <li>
                        <a href="/categories/%E8%B5%84%E6%BA%90/">
                          <i class="fa fa-cloud-download" aria-hidden="true"></i>
                          资源
                        </a>
                      </li>
                    
                      <li>
                        <a href="/categories/%E9%9A%8F%E6%83%B3/">
                          <i class="fa fa-commenting-o" aria-hidden="true"></i>
                          随想
                        </a>
                      </li>
                    
                      <li>
                        <a href="/categories/%E8%BD%AC%E8%BD%BD/">
                          <i class="fa fa-book" aria-hidden="true"></i>
                          转载
                        </a>
                      </li>
                    
                  </ul>
                
              </li>
            
              <li>
                <a href="javascript:;">
                  <span class="faa-parent animated-hover">
                    <i class="fa  fa-list-ul faa-vertical" aria-hidden="false"></i>
                    清单
                  </span>
                </a>
                
                  <ul class="sub-menu">
                    
                      <li>
                        <a href="/tags/%E6%82%A6%E8%AF%BB/">
                          <i class="fa fa-th-list faa-bounce" aria-hidden="true"></i>
                          书单
                        </a>
                      </li>
                    
                      <li>
                        <a href="/bangumi/">
                          <i class="fa fa-film faa-vertical" aria-hidden="true"></i>
                          番组
                        </a>
                      </li>
                    
                      <li>
                        <a href="/music/">
                          <i class="fa fa-headphones" aria-hidden="true"></i>
                          歌单
                        </a>
                      </li>
                    
                      <li>
                        <a href="/tags/%E5%9B%BE%E9%9B%86/">
                          <i class="fa fa-photo" aria-hidden="true"></i>
                          图集
                        </a>
                      </li>
                    
                  </ul>
                
              </li>
            
              <li>
                <a href="/comment/">
                  <span class="faa-parent animated-hover">
                    <i class="fa  fa-pencil-square-o faa-tada" aria-hidden="false"></i>
                    留言板
                  </span>
                </a>
                
              </li>
            
              <li>
                <a href="/links/">
                  <span class="faa-parent animated-hover">
                    <i class="fa  fa-link faa-shake" aria-hidden="false"></i>
                    友人帐
                  </span>
                </a>
                
              </li>
            
              <li>
                <a href="/donate/">
                  <span class="faa-parent animated-hover">
                    <i class="fa  fa-heart faa-pulse" aria-hidden="false"></i>
                    赞赏
                  </span>
                </a>
                
              </li>
            
              <li>
                <a href="/">
                  <span class="faa-parent animated-hover">
                    <i class="fa  fa-leaf faa-wrench" aria-hidden="false"></i>
                    关于
                  </span>
                </a>
                
                  <ul class="sub-menu">
                    
                      <li>
                        <a href="/about/">
                          <i class="fa fa-meetup" aria-hidden="true"></i>
                          我？
                        </a>
                      </li>
                    
                      <li>
                        <a href="/theme-sakura/">
                          <i class="fa iconfont icon-sakura" aria-hidden="true"></i>
                          主题
                        </a>
                      </li>
                    
                      <li>
                        <a href="/lab/">
                          <i class="fa fa-cogs" aria-hidden="true"></i>
                          Lab
                        </a>
                      </li>
                    
                  </ul>
                
              </li>
            
              <li>
                <a href="/client/">
                  <span class="faa-parent animated-hover">
                    <i class="fa  fa-android faa-vertical" aria-hidden="false"></i>
                    客户端
                  </span>
                </a>
                
              </li>
            
              <li>
                <a href="/atom.xml">
                  <span class="faa-parent animated-hover">
                    <i class="fa  fa-rss faa-pulse" aria-hidden="false"></i>
                    RSS
                  </span>
                </a>
                
              </li>
            
          </ul>
        </nav>
      </div>
    </div>
  </div>
</header>

      <link rel="stylesheet" type="text/css" href="/css/sharejs.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.css">
<div class="pattern-center-blank"></div>

<div id="content" class="site-content">
  <div id="primary" class="content-area">
    <main id="main" class="site-main" role="main">
      <article id="post-1" class="post-1 post type-post status-publish format-standard has-post-thumbnail hentry category-uncategorized">
        <div class="toc"></div>
        <!--<div class="toc-entry-content"><!-- 套嵌目录使用（主要为了支援评论）-->
        
          <header class="entry-header">
            <h1 class="entry-title">python并行2</h1>
            <p class="entry-census">&nbsp;·&nbsp;2021-5-14&nbsp;·&nbsp;<span id="busuanzi_value_page_pv"></span>次阅读</p></p>

            <hr>
          </header>
        
        <div class="entry-content">
          <h3 id="2-1-什么是线程"><a href="#2-1-什么是线程" class="headerlink" title="2-1 什么是线程"></a>2-1 什么是线程</h3><p>博客之前有篇文章浅显的讲了一下线程是啥，可以参考往期。这里不做过多赘述。线程由三个元素组成：程序计数器、寄存器和堆栈。与相同进程中的其他线程共享的资源基本上包括数据和操作系统资源。另外线程有自己的执行状态也就是线程状态，而且可以和其他线程同步。</p>
<p>线程状态可以是就绪，运行和阻塞。</p>
<ul>
<li><p>创建一个线程，他会进入就绪状态（ ready）</p>
</li>
<li><p>由操作系统（或者有运行时支持系统）调度一个线程执行而且轮到它执行时，它开始执行并进入运行状态（running）</p>
</li>
<li><p>线程在等待一个条件时会进入阻塞状态（blocked）例如去等一个锁。当阻塞条件中止，阻塞线程就会返回到就绪状态</p>
</li>
</ul>
<p><img src="/2021/05/14/python%E5%B9%B6%E8%A1%8C2/image-20210419204639110.png" alt="image-20210419204639110"></p>
<p>多线程编程的优点主要在性能，在上下文切换上进程切换更耗时。</p>
<h2 id="2-2-Python-Threading模块"><a href="#2-2-Python-Threading模块" class="headerlink" title="2-2 Python Threading模块"></a>2-2 Python Threading模块</h2><p>详见<a target="_blank" rel="noopener" href="https://docs.python.org/3/library/threading.html">https://docs.python.org/3/library/threading.html</a></p>
<h2 id="2-3-定义一个线程"><a href="#2-3-定义一个线程" class="headerlink" title="2-3 定义一个线程"></a>2-3 定义一个线程</h2><p>有手就行（略略略）</p>
<h3 id="2-4-确定当前线程"><a href="#2-4-确定当前线程" class="headerlink" title="2-4 确定当前线程"></a>2-4 确定当前线程</h3><p>使用参数标识和命名线程是很麻烦的。在Thread实例化（创建）的时候可以设置，不设置就是默认值。Tip.对于服务器进程（包含多个线程），对线程命名时比较必要的</p>
<h3 id="2-4-1-具体函数"><a href="#2-4-1-具体函数" class="headerlink" title="2-4-1 具体函数"></a>2-4-1 具体函数</h3><p>threading提供了currentThread().getName()方法来返回线程名</p>
<h2 id="2-5-定义线程子类"><a href="#2-5-定义线程子类" class="headerlink" title="2-5 定义线程子类"></a>2-5 定义线程子类</h2><p>经常会继承threading模块的Thread类来进行继承和重写。官方文档说了只能重写<code>___init__</code>和<code>run</code>方法 举个例子</p>
<pre><code class="python">from threading import Thread

class ThreadNew(Thread):
    def __init__(self,name):
        self.name = name
    
    def run(self):
        print(f&#39;My name is &#123;self.name&#125;&#39;)
</code></pre>
<p>这个基本原理就是继承了Thread类的init参数，但是我自己又定义了额外参数。线程从ready-&gt;running状态改变时。实际上就是历经里我们这个自定义类的<code>___init__</code>和<code>run</code>方法。</p>
<h2 id="2-5-1-关于Thread-start-和Thread-join"><a href="#2-5-1-关于Thread-start-和Thread-join" class="headerlink" title="2-5-1 关于Thread.start()和Thread.join()"></a>2-5-1 关于Thread.start()和Thread.join()</h2><p>start方法是不阻塞的，假如你把一堆线程start完了，再挨个去join。那么线程执行running顺序可能是不一样的，明明你第一个start的线程可能并不是第一个跑起来的。至于join方法</p>
<p>官方是这么说的</p>
<p><code>join(timeout=None)</code></p>
<p><code>Wait until the thread terminates. This blocks the calling thread until the thread whose joinmethod is called terminates – either normally or through an unhandled exception – or until the optional timeout occurs.</code></p>
<p>说白了，假如我希望我的线程被顺序执行，就是start一个先让他执行完再去执行下一步。</p>
<h3 id="2-6-使用锁（Lock）的线程同步"><a href="#2-6-使用锁（Lock）的线程同步" class="headerlink" title="2-6 使用锁（Lock）的线程同步"></a>2-6 使用锁（Lock）的线程同步</h3><p>threading提供了一个简单的锁机制，允许在线程间实现同步。</p>
<pre><code class="python">lock=threading.Lock()
lock.acquire() # 返回真如果拿到锁，基本都会拿到，因为拿不到也会去阻塞等待
                 但也不一定，你如果设置了非阻塞或者timeout就可能返回false
                 如果没获取成功
acquire(blocking=True,timeout=-1) # 默认-1就是never
</code></pre>
<p>这种锁的一个简单应用就是，让线程能够顺序执行在重写的Thread类中的run方法中开头加一个<code>lock.acquire()</code>这样后来start的就会因为锁被占用阻塞而等待。等run方法结束时再<code>lock.release()</code>让下一个继续run。只能保证在锁的区间保持一致，如果在run方法结束前就释放锁，那么这些进程尽管启动是顺序启动，但是结束就不会是挨个结束了。</p>
<h2 id="2-7-重入锁（RLock）"><a href="#2-7-重入锁（RLock）" class="headerlink" title="2-7 重入锁（RLock）"></a>2-7 重入锁（RLock）</h2><p>重入锁是一个同步原语（synchronization primitives）听起来有点高大上，百度百科真的拉跨搜都搜不到这个东西。在国外StackOverFlow找到解释</p>
<p><code>Synchronization primitives are simple software mechanisms provided by a platform (e.g. operating system) to its users for the purposes of  supporting thread or process synchronization. They&#39;re usually built  using lower level mechanisms (e.g. atomic operations, memory barriers,  spinlocks, context switches etc).</code></p>
<p><code>Mutex, event, conditional variables and semaphores are all  synchronization primitives. So are shared and exclusive locks. Monitor  is generally considered a high-level synchronization tool. It&#39;s an  object which guarantees mutual exclusion for its methods using other  synchronization primitives (usually exclusive locks with condition  variables to support waiting and signaling). In some contexts when  monitor is used as a building block it is also considered a  synchronization primitive.</code></p>
<p><code>Critical section is not a synchronization primitive. It&#39;s a part of  an execution path that must be protected from concurrent execution in  order to maintain some invariants. You need to use some synchronization  primitives to protect critical section.</code></p>
<p>首先吧，同步原语是一种由平台提供的软件机制，用来干嘛的？用来同步进程和线程。他们通常是由更加底层的机制构建的(例如原子操作，内存屏障，旋转锁，上下文切换等)</p>
<p>互斥锁，事件，条件变量和信号量都是同步原语。同时共享和排斥锁也是的。Monitor（不知道咋翻译）通常被认为是一种更高层面的同步工具。。。。（后面还不太懂，先不管了）</p>
<p>P.S.这书写的其实还不算太友好，Python语法倒是讲的很细，对于Python初学者能看懂。但是对于这种并行概念和原理背景能再介绍的详细点就好了 。</p>
<p>看下官网的介绍：</p>
<pre><code>A reentrant lock is a synchronization primitive that may be acquired multiple times by the same thread. Internally, it uses the concepts of “owning thread” and “recursion level” in addition to the locked/unlocked state used by primitive locks. In the locked state, some thread owns the lock; in the unlocked state, no thread owns it.

To lock the lock, a thread calls its acquire() method; this returns once the thread owns the lock. To unlock the lock, a thread calls its release() method. acquire()/release() call pairs may be nested; only the final release() (the release() of the outermost pair) resets the lock to unlocked and allows another thread blocked in acquire() to proceed.
</code></pre>
<p>对比于threading里的Lock不难看出它的主要特点是可以被同一线程多次获取，但也需要多次解锁。<code>同时重入锁还有个特点就是只能由获取锁的线程来释放，而普通的Lock则可以由任意线程释放</code> 看到这里其实我还是觉得这玩意和Lock没啥区别，直到我看了书上的例程</p>
<pre><code class="python">import threading
import time
import random


class Box:
    def __init__(self):
        self.lock = threading.RLock()
        self.total_items = 0

    def execute(self, value):
        with self.lock:
            self.total_items += value

    def add(self):
        with self.lock:
            self.execute(1)

    def remove(self):
        with self.lock:
            self.execute(-1)

def adder(box, items):
    print(&quot;N° &#123;&#125; items to ADD \n&quot;.format(items))
    while items:
        box.add()
        time.sleep(1)
        items -= 1
        print(&quot;ADDED one item --&gt;&#123;&#125; item to ADD \n&quot;.format(items))



def remover(box, items):
    print(&quot;N° &#123;&#125; items to REMOVE \n&quot;.format(items))
    while items:
        box.remove()
        time.sleep(1)
        items -= 1
        print(&quot;REMOVED one item --&gt;&#123;&#125; item to REMOVE \n&quot;.format(items))


def main():
    box = Box()

    t1 = threading.Thread(target=adder, \
                          args=(box, random.randint(10,20)))
    t2 = threading.Thread(target=remover, \
                          args=(box, random.randint(1,10)))
    
    t1.start()
    t2.start()


    t1.join()
    t2.join()
    

if __name__ == &quot;__main__&quot;:
    main()
</code></pre>
<p>来分析一下实例化了一个Box类，这个类里有物品数量默认是0，物品数量的增减通过内部<code>add</code>和<code>remove</code>方法控制，这俩方法间接调用<code>execute</code>来对实例变量item进行操作。这里开了两个线程一个是加10-20，另一个是减1-10。在每次加减时，先回把方法给锁住，就是说假如我开始加了，那么减方法就会一直被锁，每次执行增减时也会获取一个锁。增减完再一步步释放。</p>
<h3 id="2-8-信号量（semaphore）"><a href="#2-8-信号量（semaphore）" class="headerlink" title="2-8 信号量（semaphore）"></a>2-8 信号量（semaphore）</h3><p>信号量是一个由操作系统管理的抽象<code>数据类型</code>，用来同步多个线程对共享资源和数据的访问。信号量包括一个内部变量，会标识对关联资源的并发访问数。</p>
<p>具体使用</p>
<pre><code class="python">semaphore = threading.Semaphore(0) # 初始化信号量内部计数 默认是1 将其初始值设为0得到信号量事件
semaphore.acquire() # 内部计数减1
semaphore.release() # 内部计数加1
</code></pre>
<p>The <code>acquire()</code>method blocks if necessary until it can return without making the counter negative. If not given, <em>value</em> defaults to 1.也就是当计数器为0时必须先被release才能再require</p>
<p>举个实际的例子吧（抄的python doc的样例我觉得很有代表性）</p>
<p><code>Semaphores are often used to guard resources with limited capacity, for example, a database server. In any situation where the size of the resource is fixed, you should use a bounded semaphore. Before spawning any worker threads, your main thread would initialize the semaphore:</code></p>
<pre><code>maxconnections = 5
# ...
pool_sema = BoundedSemaphore(value=maxconnections)

Once spawned, worker threads call the semaphore’s acquire and release methods when they need to connect to the server:

with pool_sema:
    conn = connectdb()
    try:
        # ... use connection ...
    finally:
        conn.close()

The use of a bounded semaphore reduces the chance that a programming error which causes the semaphore to be released more than it’s acquired will go undetected.
</code></pre>
<p>就是控制数据库的最大链接量</p>
<p>这里是用的Bounded Semaphore,其实还是换汤不换药。</p>
<ul>
<li><p><em>class</em> <code>threading.``BoundedSemaphore</code>(<em>value=1</em>)</p>
<p>Class implementing bounded semaphore objects.  A bounded semaphore checks to make sure its current value doesn’t exceed its initial value.  If it does, <a target="_blank" rel="noopener" href="https://docs.python.org/3/library/exceptions.html#ValueError"><code>ValueError</code></a> is raised. In most situations semaphores are used to guard resources with limited capacity.  If the semaphore is released too many times it’s a sign of a bug.  If not given, <em>value</em> defaults to 1. Changed in version 3.3: changed from a factory function to a class.</p>
<p>说白了就是加了个内部检测机制，当信号量计数器的值始终不会超过其初始值。（其实你用的正确也不会有这种情况）但是因为默认的Semaphore是没法直观看到计数器值，所以用这个Bounded Semaphore可以避免一些意料外的错误。</p>
</li>
</ul>
<p>信号量还有种特殊用法就是互斥锁。互斥锁就是内部变量初始化为1的一个信号量（最好是BoundedSemaphore），可以实现对数据和资源的互斥访问。</p>
<p>信号量在多线程编程语言中仍很常用但有俩主要问题</p>
<ul>
<li>释放操作数要与等待操作上相同</li>
<li>可能遇到死锁情况</li>
</ul>
<h2 id="2-9-使用条件的线程同步"><a href="#2-9-使用条件的线程同步" class="headerlink" title="2.9 使用条件的线程同步"></a>2.9 使用条件的线程同步</h2><p>使用条件来进行线程同步的原理，类似于socket通信。当一个线程调用<code>condition.wait()</code>来进行阻塞，当另一个线程发出<code>condition.notify()或者是condition.notify_all()</code>另一个原本阻塞的线程便会继续运行。同时condition在初始化时如果没有传入锁，那么会默认创建一个<code>RLock</code>。当一个线程对共享的状态数据有依赖时，往往就会用condition来进行同步。如果这个状态被另一个线程改变，并调用notify，那么他就会继续运行并检测是否状态是ideal的。这个过程可以这样表示</p>
<pre><code class="python">status=&#39;sleep&#39;

def consumer():
    with condition:
        if status!=&#39;ideal&#39;:
            condition.wait()
            consumer()
        else:
            print(&#39;Success&#39;)
        
def produce():        
    with condition:
        status=&#39;ideal&#39;
        condition.notify()
</code></pre>
<p>同时由于with存在，所以说在notify后在wait的线程后不会立刻被唤醒。这是因为调用notify的线程还没有释放锁。待其线程执行完毕，锁被释放，等待的线程才会继续运行。</p>
<p>同时此处的状态检查也可以使用条件变量的<code>condition.wait_for()</code>来进行状态检测</p>
<h2 id="2-10-使用事件的线程同步"><a href="#2-10-使用事件的线程同步" class="headerlink" title="2.10 使用事件的线程同步"></a>2.10 使用事件的线程同步</h2><p>事件是用于线程间通信的一个对象。一个线程等待一个信号，另一个线程输出这个信号，进本来说event对象管理的一个内部标志，这个可以用clear()设置为false，用set()设置为True，还可用is_set()测试</p>
<p>线程可以通过wait()方法等待一个信号，用set()方法发送信号。这个比较简单直接看doc</p>
<pre><code>This is one of the simplest mechanisms for communication between threads: one thread signals an event and other threads wait for it.

An event object manages an internal flag that can be set to true with the set() method and reset to false with the clear() method. The wait() method blocks until the flag is true.

class threading.Event

    Class implementing event objects. An event manages a flag that can be set to true with the set() method and reset to false with the clear() method. The wait() method blocks until the flag is true. The flag is initially false.

    Changed in version 3.3: changed from a factory function to a class.

    is_set()

        Return True if and only if the internal flag is true.

    set()

        Set the internal flag to true. All threads waiting for it to become true are awakened. Threads that call wait() once the flag is true will not block at all.

    clear()

        Reset the internal flag to false. Subsequently, threads calling wait() will block until set() is called to set the internal flag to true again.

    wait(timeout=None)

        Block until the internal flag is true. If the internal flag is true on entry, return immediately. Otherwise, block until another thread calls set() to set the flag to true, or until the optional timeout occurs.

        When the timeout argument is present and not None, it should be a floating point number specifying a timeout for the operation in seconds (or fractions thereof).

        This method returns True if and only if the internal flag has been set to true, either before the wait call or after the wait starts, so it will always return True except if a timeout is given and the operation times out.
</code></pre>
<h2 id="2-11-使用屏障的事件同步"><a href="#2-11-使用屏障的事件同步" class="headerlink" title="2.11 使用屏障的事件同步"></a>2.11 使用屏障的事件同步</h2><p>有时，一个应用可以划分为多个阶段，其规则是：如果一个进程的所有线程没有全部完成他们的任务，进程就不能继续。屏障（Barrier）实现了这一概念：如果一个线程完成了它的阶段，会调用一个屏障原语并停止。涉及的所有线程都完成其执行阶段而且都调用了同步原语时，系统将他们全部解锁并进入下一阶段。</p>
<p>看下官方文档</p>
<pre><code>This class provides a simple synchronization primitive for use by a fixed number of threads that need to wait for each other. Each of the threads tries to pass the barrier by calling the wait() method and will block until all of the threads have made their wait() calls. At this point, the threads are released simultaneously.

The barrier can be reused any number of times for the same number of threads.

As an example, here is a simple way to synchronize a client and server thread:

b = Barrier(2, timeout=5)

def server():
    start_server()
    b.wait()
    while True:
        connection = accept_connection()
        process_server_connection(connection)

def client():
    b.wait()
    while True:
        connection = make_connection()
        process_client_connection(connection)

class threading.Barrier(parties, action=None, timeout=None)

    Create a barrier object for parties number of threads. An action, when provided, is a callable to be called by one of the threads when they are released. timeout is the default timeout value if none is specified for the wait() method.

    wait(timeout=None)

        Pass the barrier. When all the threads party to the barrier have called this function, they are all released simultaneously. If a timeout is provided, it is used in preference to any that was supplied to the class constructor.

        The return value is an integer in the range 0 to parties – 1, different for each thread. This can be used to select a thread to do some special housekeeping, e.g.:

        i = barrier.wait()
        if i == 0:
            # Only one thread needs to print this
            print(&quot;passed the barrier&quot;)

        If an action was provided to the constructor, one of the threads will have called it prior to being released. Should this call raise an error, the barrier is put into the broken state.

        If the call times out, the barrier is put into the broken state.

        This method may raise a BrokenBarrierError exception if the barrier is broken or reset while a thread is waiting.

    reset()

        Return the barrier to the default, empty state. Any threads waiting on it will receive the BrokenBarrierError exception.

        Note that using this function may require some external synchronization if there are other threads whose state is unknown. If a barrier is broken it may be better to just leave it and create a new one.

    abort()

        Put the barrier into a broken state. This causes any active or future calls to wait() to fail with the BrokenBarrierError. Use this for example if one of the threads needs to abort, to avoid deadlocking the application.

        It may be preferable to simply create the barrier with a sensible timeout value to automatically guard against one of the threads going awry.

    parties

        The number of threads required to pass the barrier.

    n_waiting

        The number of threads currently waiting in the barrier.

    broken

        A boolean that is True if the barrier is in the broken state.

exception threading.BrokenBarrierError

    This exception, a subclass of RuntimeError, is raised when the Barrier object is reset or broken.
</code></pre>
<p>官方样例代码就是保证服务端启动，客户端才能继续接下来的动作。再看下书上的代码。</p>
<pre><code class="python">from random import randrange
from threading import Barrier, Thread
from time import ctime, sleep

num_runners = 3
finish_line = Barrier(num_runners)
runners = [&#39;Huey&#39;, &#39;Dewey&#39;, &#39;Louie&#39;]

def runner():
    name = runners.pop()
    sleep(randrange(2, 5))
    print(&#39;%s reached the barrier at: %s \n&#39; % (name, ctime()))
    finish_line.wait()

def main():
    threads = []
    print(&#39;START RACE!!!!&#39;)
    for i in range(num_runners):
        threads.append(Thread(target=runner))
        threads[-1].start()
    for thread in threads:
        thread.join()
    print(&#39;Race over!&#39;)

if __name__ == &quot;__main__&quot;:
    main()
</code></pre>
<p>启动了三个线程，代表三个赛跑者。他们依次到达终点后，都进入等待状态，直到等待数为选手数，表明都到了终点，main函数从阻塞中恢复，打印比赛结束</p>
<h2 id="2-12-使用队列的线程通讯"><a href="#2-12-使用队列的线程通讯" class="headerlink" title="2-12 使用队列的线程通讯"></a>2-12 使用队列的线程通讯</h2><p>线程需要共享数据和资源时，多线程可能很复杂。幸运的是threading模块提供了很多的同步原语</p>
<p>包括信号量、条件变量、事件和锁。</p>
<p>不过使用queue模块被认为是一个最可行的办法。实际上处理队列要容易得多，这使得多线程编程更加安全，因为它会有效的将对一个资源的所有访问排队，实现一种更简介、可读的设计模式。</p>
<p>我们只需要考虑如下队列方法：</p>
<ul>
<li>put():在队列中放入一个元素。</li>
<li>get():从队列删除并返回一个元素。</li>
<li>task_done():每次处理一个元素时需要调用这个方法</li>
<li>join():阻塞，直到所有元素都被处理</li>
</ul>
<p>The <a target="_blank" rel="noopener" href="https://docs.python.org/3/library/queue.html#module-queue"><code>queue</code></a> module implements multi-producer, multi-consumer queues. It is especially useful in threaded programming when information must be exchanged safely between multiple threads.  The <a target="_blank" rel="noopener" href="https://docs.python.org/3/library/queue.html#queue.Queue"><code>Queue</code></a> class in this module implements all the required locking semantics.</p>
<p>The module implements three types of queue, which differ only in the order in which the entries are retrieved.  In a FIFO queue, the first tasks added are the first retrieved. In a LIFO queue, the most recently added entry is the first retrieved (operating like a stack).  With a priority queue, the entries are kept sorted (using the <a target="_blank" rel="noopener" href="https://docs.python.org/3/library/heapq.html#module-heapq"><code>heapq</code></a> module) and the lowest valued entry is retrieved first.</p>
<p>Internally, those three types of queues use locks to temporarily block competing threads; however, they are not designed to handle reentrancy within a thread.</p>
<p>In addition, the module implements a “simple” FIFO queue type, <a target="_blank" rel="noopener" href="https://docs.python.org/3/library/queue.html#queue.SimpleQueue"><code>SimpleQueue</code></a>, whose specific implementation provides additional guarantees in exchange for the smaller functionality.</p>

        </div>
        <!-- .entry-content -->
        <div class="single-reward">
          <div class="reward-open">赏
            <div class="reward-main">
              <ul class="reward-row">
                <li class="alipay-code"><img src="https://cdn.jsdelivr.net/gh/zwh-china/cdn@master/img/custom/donate/AliPayQR.jpg"></li>
                <li class="wechat-code"><img src="https://cdn.jsdelivr.net/gh/zwh-china/cdn@master/img/custom/donate/WeChanQR.jpg"></li>
              </ul>
            </div>
          </div>
        </div>
        <div style="text-align:center; width: 100%" class="social-share share-mobile" data-disabled="diandian, tencent"></div>
        <footer class="post-footer">
          <div class="post-lincenses"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="nofollow"><i class="fa fa-creative-commons" aria-hidden="true"></i> 知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a></div>
          <div class="post-tags">
          </div>
          <div class="post-share">
            <div class="social-share sharehidden share-component"></div>
            <i class="iconfont show-share icon-forward"></i>
          </div>
        </footer><!-- .entry-footer -->
      </article>
      <!-- #post-## -->
      <div class="toc" style="background: none;"></div>
      <section class="post-squares nextprev">
        
          
            <div class="post-nepre half previous">
          
            <a href="/2021/05/23/%E4%B8%80%E9%81%93php%E9%A2%98%E7%9B%AE%E7%9A%84%E5%A4%8D%E7%8E%B0/" rel="prev">
              <div class="background">
                <img class="lazyload" src="https://cdn.jsdelivr.net/gh/honjun/cdn@1.6/img/loader/orange.progress-bar-stripe-loader.svg" data-src="" style="width: 100%; height: 100%; object-fit: cover; pointer-events: none;" onerror="imgError(this,3)" src="">
              </div>
              <span class="label">
              Previous Post</span>
              <div class="info">
                <h3>
                一道php题目的复现 one_pointer_php</h3>
                <hr>
              </div>
            </a>
          </div>
        
        
          
            <div class="post-nepre half next">
          
            <a href="/2021/05/14/%E7%BA%A2%E5%B8%BD%E6%9D%AF/" rel="next">
              <div class="background">
                <img class="lazyload" src="https://cdn.jsdelivr.net/gh/honjun/cdn@1.6/img/loader/orange.progress-bar-stripe-loader.svg" data-src="" style="width: 100%; height: 100%; object-fit: cover; pointer-events: none;" onerror="imgError(this,3)" src="">
              </div>
              <span class="label">
              Next Post</span>
              <div class="info">
                <h3>
                红帽杯wp</h3>
                <hr>
              </div>
            </a>
          </div>
        
      </section>
      
<div id="vcomments"></div>
<script>
  window.onload = function(){
      var valine = new Valine();
      valine.init({
        el: '#vcomments',
        appId: "isAVAfjr2p1f1KqnKuKxD4va-gzGzoHsz",
        appKey: "aVVjA76SnnAo2kP4S9BuGwW4",
        path: window.location.pathname,
        placeholder: "你是我一生只会遇见一次的惊喜 ..."
      })
  }
</script>

<section class="author-profile">
    <div class="info" itemprop="author" itemscope="" itemtype="https://schema.org/Person">
      <a href="/about/" class="profile gravatar"><img src="https://cdn.jsdelivr.net/gh/zwh-china/cdn@master/img/custom/avatar.jpg" itemprop="image" alt="雨过天晴&伞落人离" height="70" width="70"></a>
      <div class="meta">
        <span class="title">Author</span>
        <h3 itemprop="name">
        <a href="https://zwh-china.github.io" itemprop="url" rel="author">雨过天晴&伞落人离</a>
        </h3>
      </div>
    </div>
    <hr>
    <p><i class="iconfont icon-write"></i>一沙一世界，一花一天堂。君掌盛无边，刹那成永恒。</p>
  </section>
</div>



    </div>    
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="Type something..."/>
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: 'Posts',
            // PAGES: 'Pages',
            CATEGORIES: 'Categories',
            TAGS: 'Tags',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
    <!-- <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2021 雨过天晴&amp;伞落人离<br>
      powered_by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer> -->
<footer id="colophon" class="site-footer" role="contentinfo">
  <div class="site-info">
    <div class="footertext">
      <div class="img-preload">
        <img src="https://cdn.jsdelivr.net/gh/honjun/cdn@1.6/img/other/wordpress-rotating-ball-o.svg">
        <img src="https://cdn.jsdelivr.net/gh/honjun/cdn@1.6/img/other/disqus-preloader.svg">
      </div>
      <p style="color: #666666;">&copy 2018</p>
    </div>
    <div class="footer-device">
    <p style="font-family: 'Ubuntu', sans-serif;">
        <span style="color: #b9b9b9;">Theme <a href="https://github.com/honjun/hexo-theme-sakura" target="_blank" style="color: #b9b9b9;;text-decoration: underline dotted rgba(0, 0, 0, .1);">Sakura</a> <i class="iconfont icon-sakura rotating" style="color: #ffc0cb;display:inline-block"></i> by <a href="https://2heng.xin/" target="_blank" style="color: #b9b9b9;;text-decoration: underline dotted rgba(0, 0, 0, .1);">Mashiro</a>&<a href="https://www.hojun.cn/" target="_blank" style="color: #b9b9b9;;text-decoration: underline dotted rgba(0, 0, 0, .1);">Hojun</a>, Powered by Hexo, Hosted by Coding Pages</a>
        </span>
      </p>
    </div>
  </div><!-- .site-info -->
</footer>



<!-- <script src="/js/tocbot.js"></script> -->
<script type="text/javascript" src="/js/lib.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
<script type="text/javascript" src="/js/InsightSearch.js"></script>
<script type="text/javascript" src="/js/jquery.fancybox.min.js"></script>
<script type="text/javascript" src="/js/zoom.min.js"></script>
<script type="text/javascript" src="/js/sakura-app.js"></script>
<script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src='//unpkg.com/valine@1.3.4/dist/Valine.min.js'></script>
<script src="/js/botui.js"></script>
<!-- 不蒜子 网页计数器 -->
<script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.min.js"></script> -->
<script type="text/javascript">
/* <![CDATA[ */
if (/Android|webOS|iPhone|iPod|BlackBerry/i.test(navigator.userAgent)) {
  var Poi = {"pjax":"1","movies":{"url": "","name":"","live":"close"},"windowheight":"fixed","codelamp":"close","ajaxurl":"","order":"asc","formpostion":"bottom"};
} else {
  var Poi = {"pjax":"1","movies":{"url": "","name":"","live":"open"},"windowheight":"auto","codelamp":"close","ajaxurl":"","order":"asc","formpostion":"bottom"};
}
/* ]]> */

</script>
<script>
$(document).ready(function() {
  if ($(".toc").length > 0 && document.body.clientWidth > 1200) {
    if ($(".pattern-center").length > 0) { //有图的情况
      tocbot.init({
          // Where to render the table of contents.
          tocSelector: '.toc', // 放置目录的容器
          // Where to grab the headings to build the table of contents.
          contentSelector: '.entry-content', // 正文内容所在
          // Which headings to grab inside of the contentSelector element.
          scrollSmooth: true,
          headingSelector: 'h1, h2, h3, h4, h5', // 需要索引的标题级别
          headingsOffset: -400,
          scrollSmoothOffset: -85
      });
    } else {
      tocbot.init({
          // Where to render the table of contents.
          tocSelector: '.toc', // 放置目录的容器
          // Where to grab the headings to build the table of contents.
          contentSelector: '.entry-content', // 正文内容所在
          // Which headings to grab inside of the contentSelector element.
          scrollSmooth: true,
          headingSelector: 'h1, h2, h3, h4, h5', // 需要索引的标题级别
          headingsOffset: -85,
          scrollSmoothOffset: -85
      });
    }
    var offsetTop = $('.toc').offset().top - 95;
    window.onscroll = function() {
      var scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop;
      if (scrollTop >= offsetTop) {
        $('.toc').addClass('toc-fixed');
      } else {
        $('.toc').removeClass('toc-fixed');
      }
    }
  }
});
</script>
<!-- 🌸飘落 -->

    <div class="openNav no-select" style="height: 50px;">
      <div class="iconflat no-select" style="width: 50px; height: 50px;">
        <div class="icon"></div>
      </div>
      <div class="site-branding search-form-submit">
        <i class="iconfont js-toggle-search iconsearch icon-search"></i>
      </div>
    </div>
  </section>
  <div class="skin-menu no-select" id="mainskin" style="position: fixed">
 <div class="theme-controls row-container">
  <ul class="menu-list">
   <li id="white-bg"> <i class="fa fa-television" aria-hidden="true"></i></li>
   <li id="sakura-bg"> <i class="iconfont icon-sakura"></i></li>
   <li id="gribs-bg"> <i class="fa fa-slack" aria-hidden="true"></i></li>
   <li id="KAdots-bg"> <i class="iconfont icon-dots"></i></li>
   <li id="totem-bg"> <i class="fa fa-optin-monster" aria-hidden="true"></i></li>
   <li id="pixiv-bg"> <i class="iconfont icon-pixiv"></i></li>
   <li id="bing-bg"> <i class="iconfont icon-bing"></i></li>
   <li id="dark-bg"> <i class="fa fa-moon-o" aria-hidden="true"></i></li>
  </ul>
 </div>
</div>
<canvas id="night-mode-cover"></canvas> 
  <div class="changeSkin-gear no-select">
  <div class="keys" id="setbtn"> 
   <span id="open-skinMenu"> 切换主题 | SCHEME TOOL  
     <i class="iconfont icon-gear inline-block rotating"></i> 
   </span>
  </div>
</div>
  <div id="mo-nav" class="">
  <div class="m-avatar">
    <img src="https://cdn.jsdelivr.net/gh/zwh-china/cdn@master/img/custom/avatar.jpg">
  </div>
  <p style="text-align: center; color: #333; font-weight: 900; font-family: 'Ubuntu', sans-serif; letter-spacing: 1.5px">雨过天晴&伞落人离's Blog</p>
  <p style="text-align: center; word-spacing: 20px;">
    
      
        <a href="http://github.com/zwh-china" class="fa fa-github" target="_blank" style="color: #333; margin-left:20px"></a>
      
        <a href="http://weibo.com/" class="fa fa-weibo" target="_blank" style="color: #dd4b39; margin-left:20px"></a>
      
        <a href="https://wpa.qq.com/msgrd?v=3&uin=2540649733&site=qq&menu=yes" class="fa fa-qq" target="_blank" style="color: #25c6fe; margin-left:20px"></a>
      
    
  </p>
  <ul id="menu-new-1" class="menu">
    
      <li>
        <a href="/">
          <span class="faa-parent animated-hover">
            <i class="fa  fa-fort-awesome faa-shake" aria-hidden="true"></i>
            首页
          </span>
        </a>
        
      </li>
    
      <li>
        <a href="/archives">
          <span class="faa-parent animated-hover">
            <i class="fa  fa-archive faa-shake" aria-hidden="true"></i>
            归档
          </span>
        </a>
        
          <ul class="sub-menu">
            
              <li>
                <a href="/categories/%E6%8A%80%E6%9C%AF/">
                  <i class="fa fa-code" aria-hidden="true"></i>
                  技术
                </a>
              </li>
            
              <li>
                <a href="/categories/%E7%94%9F%E6%B4%BB/">
                  <i class="fa fa-file-text-o" aria-hidden="true"></i>
                  生活
                </a>
              </li>
            
              <li>
                <a href="/categories/%E8%B5%84%E6%BA%90/">
                  <i class="fa fa-cloud-download" aria-hidden="true"></i>
                  资源
                </a>
              </li>
            
              <li>
                <a href="/categories/%E9%9A%8F%E6%83%B3/">
                  <i class="fa fa-commenting-o" aria-hidden="true"></i>
                  随想
                </a>
              </li>
            
              <li>
                <a href="/categories/%E8%BD%AC%E8%BD%BD/">
                  <i class="fa fa-book" aria-hidden="true"></i>
                  转载
                </a>
              </li>
            
          </ul>
        
      </li>
    
      <li>
        <a href="javascript:;">
          <span class="faa-parent animated-hover">
            <i class="fa  fa-list-ul faa-vertical" aria-hidden="true"></i>
            清单
          </span>
        </a>
        
          <ul class="sub-menu">
            
              <li>
                <a href="/tags/%E6%82%A6%E8%AF%BB/">
                  <i class="fa fa-th-list faa-bounce" aria-hidden="true"></i>
                  书单
                </a>
              </li>
            
              <li>
                <a href="/bangumi/">
                  <i class="fa fa-film faa-vertical" aria-hidden="true"></i>
                  番组
                </a>
              </li>
            
              <li>
                <a href="/music/">
                  <i class="fa fa-headphones" aria-hidden="true"></i>
                  歌单
                </a>
              </li>
            
              <li>
                <a href="/tags/%E5%9B%BE%E9%9B%86/">
                  <i class="fa fa-photo" aria-hidden="true"></i>
                  图集
                </a>
              </li>
            
          </ul>
        
      </li>
    
      <li>
        <a href="/comment/">
          <span class="faa-parent animated-hover">
            <i class="fa  fa-pencil-square-o faa-tada" aria-hidden="true"></i>
            留言板
          </span>
        </a>
        
      </li>
    
      <li>
        <a href="/links/">
          <span class="faa-parent animated-hover">
            <i class="fa  fa-link faa-shake" aria-hidden="true"></i>
            友人帐
          </span>
        </a>
        
      </li>
    
      <li>
        <a href="/donate/">
          <span class="faa-parent animated-hover">
            <i class="fa  fa-heart faa-pulse" aria-hidden="true"></i>
            赞赏
          </span>
        </a>
        
      </li>
    
      <li>
        <a href="/">
          <span class="faa-parent animated-hover">
            <i class="fa  fa-leaf faa-wrench" aria-hidden="true"></i>
            关于
          </span>
        </a>
        
          <ul class="sub-menu">
            
              <li>
                <a href="/about/">
                  <i class="fa fa-meetup" aria-hidden="true"></i>
                  我？
                </a>
              </li>
            
              <li>
                <a href="/theme-sakura/">
                  <i class="fa iconfont icon-sakura" aria-hidden="true"></i>
                  主题
                </a>
              </li>
            
              <li>
                <a href="/lab/">
                  <i class="fa fa-cogs" aria-hidden="true"></i>
                  Lab
                </a>
              </li>
            
          </ul>
        
      </li>
    
      <li>
        <a href="/client/">
          <span class="faa-parent animated-hover">
            <i class="fa  fa-android faa-vertical" aria-hidden="true"></i>
            客户端
          </span>
        </a>
        
      </li>
    
      <li>
        <a href="/atom.xml">
          <span class="faa-parent animated-hover">
            <i class="fa  fa-rss faa-pulse" aria-hidden="true"></i>
            RSS
          </span>
        </a>
        
      </li>
    
  </ul>
  <p style="text-align: center; font-size: 13px; color: #b9b9b9;">&copy 2019 hexo-sakura</p>
</div>
<button onclick="topFunction()" class="mobile-cd-top" id="moblieGoTop" title="Go to top" style="display: none;"><i class="fa fa-chevron-up" aria-hidden="true"></i></button>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css">
<script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script>
<!-- require MetingJS -->
<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>
<style>
  .aplayer .aplayer-lrc {
    height: 35px;
  }
  .aplayer .aplayer-lrc p{
    font-size: 16px;
    font-weight: 700;
    line-height: 18px !important;
  }
  .aplayer .aplayer-lrc p.aplayer-lrc-current{
    color: #FF1493;
  }
  .aplayer.aplayer-narrow .aplayer-body{
    left: -66px !important;
  }
  .aplayer.aplayer-fixed .aplayer-lrc {
    display: none;
  }
  .aplayer .aplayer-lrc.aplayer-lrc-hide {
      display:none !important;
  }
  .aplayer.aplayer-fixed .lrc-show {
    display: block;
    background: rgba(255, 255, 255, 0.8);
  }
</style>
<meting-js

    id="2660651585"

    server="netease"

    type="playlist"

    fixed="true"

    autoplay="false"

    loop="all"

    order="random"

    preload="auto"

    volume="0.7"

    mutex="true"

</meting-js>
<script>
  $(function(){
    $('body').on('click', '.aplayer', function(){
      if($('.aplayer-button').hasClass('aplayer-play')) {
        $('.aplayer-lrc').removeClass('lrc-show');
      } else {
        $('.aplayer-lrc').addClass('lrc-show');
      }
    })
  });
</script>

</body>
</html>
<script src="https://cdn.jsdelivr.net/gh/stevenjoezhang/live2d-widget@latest/autoload.js"></script>